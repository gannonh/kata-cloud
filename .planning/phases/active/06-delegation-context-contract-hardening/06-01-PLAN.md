---
phase: 06-delegation-context-contract-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/context/types.ts
  - src/context/context-adapter.ts
  - src/context/providers/filesystem-context-provider.ts
  - src/context/providers/mcp-context-provider.ts
  - src/context/context-adapter.node.test.ts
autonomous: true
must_haves:
  truths:
    - Context retrieval uses a stable typed request/response contract instead of ambiguous array-only returns.
    - Context provider failures are expressed as typed outcomes with explicit remediation metadata.
    - Adapter-level behavior for fallback and provider-not-available paths is deterministic and test-covered.
  artifacts:
    - src/context/types.ts
    - src/context/context-adapter.ts
    - src/context/providers/filesystem-context-provider.ts
    - src/context/providers/mcp-context-provider.ts
    - src/context/context-adapter.node.test.ts
  key_links:
    - Context provider results are normalized through a shared adapter contract before crossing IPC boundaries.
    - Provider-specific failure conditions map to a common context error shape consumable by main/preload/renderer.
---

<objective>
Define and validate the typed context retrieval contract needed for CTX-01 and CTX-02.

Purpose: Remove ambiguity in context retrieval behavior so downstream IPC and renderer flows can reliably distinguish success, no matches, and actionable failures.
Output: Updated context domain types/adapter/provider behavior with focused node tests proving deterministic success/failure outcomes.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/pending/06-delegation-context-contract-hardening/06-RESEARCH.md
@src/context/types.ts
@src/context/context-adapter.ts
@src/context/context-adapter.node.test.ts
@src/context/providers/filesystem-context-provider.ts
@src/context/providers/mcp-context-provider.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Introduce explicit context retrieval result/error contracts in shared context types</name>
  <files>src/context/types.ts, src/context/context-adapter.ts</files>
  <action>Add a typed retrieval outcome contract (success/failure union) with stable error codes, remediation text, and retryability metadata. Update adapter signatures to return this contract and keep provider selection fallback deterministic. Preserve backward-compatible request fields while tightening type expectations for providerId/rootPath/limit handling.</action>
  <verify>pnpm test -- context-adapter</verify>
  <done>Context adapter API returns typed retrieval outcomes that let callers distinguish success, empty results, and actionable failures without guessing from raw arrays.</done>
</task>

<task type="auto">
  <name>Task 2: Normalize provider implementations to emit deterministic typed outcomes</name>
  <files>src/context/providers/filesystem-context-provider.ts, src/context/providers/mcp-context-provider.ts</files>
  <action>Update provider implementations to report structured retrieval failures where appropriate (unavailable provider/runtime, invalid query/root path, unrecoverable IO issues) while preserving successful snippet retrieval behavior. Keep filesystem scanning resiliency for per-file read failures but ensure provider-level fatal paths produce explicit typed errors.</action>
  <verify>pnpm test -- context-adapter</verify>
  <done>Provider behavior is deterministic and surfaced through the shared outcome contract, with no silent provider-level failure collapse to ambiguous empty snippet arrays.</done>
</task>

<task type="auto">
  <name>Task 3: Expand context adapter node tests for success, fallback, and typed failure paths</name>
  <files>src/context/context-adapter.node.test.ts</files>
  <action>Add/adjust tests to cover successful retrieval, default-provider fallback behavior, and failure outcomes from unavailable/unsupported providers. Assert on typed outcome shape (including error code/remediation/retryable metadata) rather than only snippet-array length checks.</action>
  <verify>pnpm test -- context-adapter</verify>
  <done>Node tests enforce the typed context contract and prevent regressions to ambiguous retrieval semantics.</done>
</task>

</tasks>

<verification>
1. Run `pnpm test -- context-adapter`.
2. Run `pnpm run desktop:typecheck`.
</verification>

<success_criteria>
- CTX-01 foundation exists: context retrieval contracts are typed and explicit.
- Context provider and adapter failures are represented as structured outcomes with actionable metadata.
- Adapter/provider behavior remains deterministic under fallback and unsupported-provider scenarios.
</success_criteria>

<output>
After completion, create `.planning/phases/pending/06-delegation-context-contract-hardening/06-01-SUMMARY.md`
</output>
