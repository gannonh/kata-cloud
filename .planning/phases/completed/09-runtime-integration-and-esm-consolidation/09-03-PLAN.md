---
phase: 09-runtime-integration-and-esm-consolidation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.main.json
  - bin/postbuild-main.mjs
  - src/main/index.ts
  - src/preload/index.ts
  - bin/playwright-electron-runner.mjs
autonomous: true

must_haves:
  truths:
    - "Desktop build/runtime path no longer depends on dedicated CommonJS preload side-build."
    - "Preload bridge (`window.kataShell`) remains operational after module-path consolidation."
    - "Build and smoke verification prove ESM-first runtime integrity in dev and packaged pathways."
  artifacts:
    - path: "package.json"
      provides: "Build pipeline updated to remove CommonJS preload compilation branch"
    - path: "src/main/index.ts"
      provides: "BrowserWindow preload target aligned to consolidated module output"
    - path: "bin/playwright-electron-runner.mjs"
      provides: "Smoke assertions remain valid against consolidated preload path"
  key_links:
    - from: "package.json"
      to: "src/main/index.ts"
      via: "Desktop build output path and BrowserWindow preload path are consistent"
      pattern: "desktop:build-main"
    - from: "src/preload/index.ts"
      to: "bin/playwright-electron-runner.mjs"
      via: "kataShell bridge contract verified by Electron smoke scenario"
      pattern: "window.kataShell"
---

<objective>
Consolidate desktop module/build pathways to ESM-first operation by removing the preload CommonJS side-build debt.

Purpose: Align runtime architecture with TypeScript/ESM direction and reduce build complexity before major v0.2 UI execution.
Output: Unified build path, aligned preload target, and smoke-verified bridge behavior.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/pending/09-runtime-integration-and-esm-consolidation/09-RESEARCH.md
@package.json
@tsconfig.main.json
@bin/postbuild-main.mjs
@src/main/index.ts
@src/preload/index.ts
@bin/playwright-electron-runner.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace preload CommonJS side-build with unified NodeNext-aligned output</name>
  <files>
    package.json
    tsconfig.main.json
    bin/postbuild-main.mjs
  </files>
  <action>
Remove the dedicated preload CommonJS compilation step and converge on a single TypeScript build pathway compatible with the projectâ€™s ESM strategy. Eliminate or repurpose `postbuild-main` behavior so build output paths remain deterministic and minimal.
  </action>
  <verify>
    `pnpm run build`
  </verify>
  <done>
    Build no longer relies on `dist/preload-cjs` + copy-to-`.cjs` workflow and still completes successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Align runtime preload path and bridge loading to consolidated output</name>
  <files>
    src/main/index.ts
    src/preload/index.ts
  </files>
  <action>
Update BrowserWindow preload path resolution to the consolidated artifact and ensure preload bridge loading remains compatible with Electron sandbox constraints. Keep `kataShell` API surface unchanged.
  </action>
  <verify>
    `pnpm run desktop:typecheck`
  </verify>
  <done>
    Main process can create windows with the new preload artifact path, and preload bridge typing/runtime behavior remain intact.
  </done>
</task>

<task type="auto">
  <name>Task 3: Reconfirm smoke guardrails for bridge integrity after module consolidation</name>
  <files>
    bin/playwright-electron-runner.mjs
    src/main/index.ts
  </files>
  <action>
Adjust smoke assertions only where artifact paths changed, then run baseline Electron smoke verification to ensure `window.kataShell` and changes wiring still pass under consolidated module output.
  </action>
  <verify>
    `pnpm run e2e:electron:smoke`
  </verify>
  <done>
    Smoke suite passes and bridge integrity is proven after module-path consolidation.
  </done>
</task>

</tasks>

<verification>
1. `pnpm run build`
2. `pnpm run desktop:typecheck`
3. `pnpm run e2e:electron:smoke`
</verification>

<success_criteria>
- PI-03 module-strategy requirement is satisfied for milestone execution path.
- Desktop build path is simpler and free of preload CommonJS side-build dependency.
- Shell bridge behavior remains validated by smoke coverage.
</success_criteria>

<output>
After completion, create `.planning/phases/pending/09-runtime-integration-and-esm-consolidation/09-03-SUMMARY.md`
</output>
