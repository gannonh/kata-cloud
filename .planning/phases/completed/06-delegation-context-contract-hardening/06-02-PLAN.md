---
phase: 06-delegation-context-contract-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/shared/orchestrator-run-persistence.ts
  - src/shared/orchestrator-run-persistence.test.ts
  - src/shared/state.ts
  - src/shared/state.test.ts
  - src/shared/orchestrator-state.test.ts
autonomous: true
must_haves:
  truths:
    - Historical runs keep lifecycle timelines and delegated outcomes intact across save/reload normalization.
    - Run updates are applied with id-scoped deterministic helpers to reduce stale snapshot overwrite risk.
    - Invalid nested run payload fragments do not unnecessarily erase otherwise valid historical run records.
  artifacts:
    - src/shared/orchestrator-run-persistence.ts
    - src/shared/orchestrator-run-persistence.test.ts
    - src/shared/state.ts
    - src/shared/state.test.ts
    - src/shared/orchestrator-state.test.ts
  key_links:
    - Main orchestration flow can call shared run-persistence helpers instead of ad-hoc map/mutation blocks.
    - App-state normalization preserves valid run/delegated data contracts while enforcing lifecycle integrity.
---

<objective>
Harden run-history persistence contracts for ORCH-03 and ORCH-04 before renderer/main integration wiring.

Purpose: Ensure save/reload behavior is recoverable and deterministic for lifecycle + delegated outcomes, even when partial nested payload corruption exists.
Output: Shared run persistence helper module plus state normalization/test updates that lock historical run integrity.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/pending/06-delegation-context-contract-hardening/06-RESEARCH.md
@src/shared/state.ts
@src/shared/state.test.ts
@src/shared/orchestrator-state.test.ts
@src/shared/orchestrator-run-lifecycle.ts
@src/shared/orchestrator-run-history.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add shared run-persistence helpers for enqueue/transition/finalize update semantics</name>
  <files>src/shared/orchestrator-run-persistence.ts, src/shared/orchestrator-run-persistence.test.ts</files>
  <action>Create a focused helper module that performs immutable id-scoped run updates (append queued run, apply lifecycle transition output, attach delegated outcomes/draft/diagnostics). Keep APIs deterministic and independent from React state hooks so renderer and tests can reuse the same logic.</action>
  <verify>pnpm test -- orchestrator-run-persistence</verify>
  <done>Run-persistence helper APIs provide deterministic update operations that cover the full run lifecycle without broad ad-hoc array mutation code.</done>
</task>

<task type="auto">
  <name>Task 2: Tighten state normalization for recoverability of historical run records</name>
  <files>src/shared/state.ts</files>
  <action>Refine run normalization behavior so core lifecycle integrity remains strict while optional nested payloads (for example malformed delegated entries) are handled in a recoverability-first way where safe. Preserve explicit lifecycle rejection for invalid status/timeline transitions and keep linked space/session filtering intact.</action>
  <verify>pnpm test -- state</verify>
  <done>Valid runs with valid lifecycle metadata survive normalization even when optional nested payload fragments are invalid, and invalid lifecycle records continue to be rejected deterministically.</done>
</task>

<task type="auto">
  <name>Task 3: Add regression tests for save/reload run-history integrity and failure recovery</name>
  <files>src/shared/state.test.ts, src/shared/orchestrator-state.test.ts, src/shared/orchestrator-run-persistence.test.ts</files>
  <action>Add tests for persisted run-history retention, delegated outcome preservation, and deterministic behavior when orchestrator failures occur mid-flow. Include at least one scenario validating that active session linkage and prior run records remain stable after normalization and update helper operations.</action>
  <verify>pnpm test -- state && pnpm test -- orchestrator-state && pnpm test -- orchestrator-run-persistence</verify>
  <done>Regression coverage demonstrates ORCH-03/ORCH-04 persistence expectations and protects against historical run loss regressions.</done>
</task>

</tasks>

<verification>
1. Run `pnpm test -- orchestrator-run-persistence`.
2. Run `pnpm test -- state`.
3. Run `pnpm test -- orchestrator-state`.
</verification>

<success_criteria>
- ORCH-03 foundation exists: historical run records and delegated outcomes persist across normalization.
- ORCH-04 foundation exists: deterministic run updates are available as shared helpers rather than ad-hoc renderer snapshot edits.
- Save/reload regression tests lock run-history integrity behavior.
</success_criteria>

<output>
After completion, create `.planning/phases/pending/06-delegation-context-contract-hardening/06-02-SUMMARY.md`
</output>
