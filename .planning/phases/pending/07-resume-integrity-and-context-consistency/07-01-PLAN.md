---
phase: 07-resume-integrity-and-context-consistency
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/shared/state.ts
  - src/shared/state.test.ts
  - src/shared/orchestrator-run-lifecycle.ts
  - src/shared/orchestrator-run-lifecycle.test.ts
  - src/shared/orchestrator-run-view-model.ts
  - src/shared/orchestrator-run-view-model.test.ts
autonomous: true

must_haves:
  truths:
    - "Interrupted run status is a valid terminal status that persisted run records can hold"
    - "Run records with 'interrupted' status survive normalizeAppState round-trip without being dropped"
    - "View model labels interrupted runs as 'Interrupted' distinctly from running or failed"
    - "Run records carry a resolvedProviderId field that records which context provider was used"
    - "View model projects context provenance (provider, snippet count, fallback indicator) for runs that have resolvedProviderId"
  artifacts:
    - path: "src/shared/state.ts"
      provides: "OrchestratorRunStatus with 'interrupted', OrchestratorRunRecord with resolvedProviderId and interruptedAt"
    - path: "src/shared/orchestrator-run-lifecycle.ts"
      provides: "ALLOWED_RUN_TRANSITIONS including queued->interrupted and running->interrupted"
    - path: "src/shared/orchestrator-run-view-model.ts"
      provides: "OrchestratorRunContextProvenance interface, contextProvenance field, 'Interrupted' status label"
  key_links:
    - from: "src/shared/state.ts"
      to: "src/shared/orchestrator-run-lifecycle.ts"
      via: "ALLOWED_RUN_TRANSITIONS import used in hasValidRunTimeline"
      pattern: "ALLOWED_RUN_TRANSITIONS\\[from\\]\\.includes"
    - from: "src/shared/orchestrator-run-view-model.ts"
      to: "src/shared/state.ts"
      via: "OrchestratorRunRecord import with resolvedProviderId field"
      pattern: "run\\.resolvedProviderId"
---

<objective>
Add interrupted-run status and context provenance fields to shared contracts.

Purpose: Establish the type-level foundation for interrupted-run recovery (SESS-01/02/03) and context grounding traceability (CTX-03/04). All downstream runtime and renderer changes depend on these contract extensions.
Output: Updated shared types, lifecycle transitions, normalization guards, view model projections, and regression tests.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/shared/state.ts
@src/shared/state.test.ts
@src/shared/orchestrator-run-lifecycle.ts
@src/shared/orchestrator-run-lifecycle.test.ts
@src/shared/orchestrator-run-view-model.ts
@src/shared/orchestrator-run-view-model.test.ts
@src/context/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add interrupted status to run lifecycle contracts and normalization</name>
  <files>
    src/shared/state.ts
    src/shared/state.test.ts
    src/shared/orchestrator-run-lifecycle.ts
    src/shared/orchestrator-run-lifecycle.test.ts
  </files>
  <action>
1. In `src/shared/state.ts`:
   - Extend `OrchestratorRunStatus` type to include `"interrupted"`:
     `export type OrchestratorRunStatus = "queued" | "running" | "completed" | "failed" | "interrupted";`
   - Add optional `interruptedAt?: string` field to `OrchestratorRunRecord` interface (alongside existing `completedAt`).
   - Add optional `resolvedProviderId?: ContextProviderId` field to `OrchestratorRunRecord` interface. Import `ContextProviderId` is already available.
   - Update `isOrchestratorRunStatus` guard to include `"interrupted"`:
     `return value === "queued" || value === "running" || value === "completed" || value === "failed" || value === "interrupted";`
   - Update `normalizeOrchestratorRunRecord`:
     - Change `terminalStatus` check to: `const terminalStatus = runStatus === "completed" || runStatus === "failed";`
     - Add `const interruptedStatus = runStatus === "interrupted";`
     - Change the completedAt requirement: terminal runs require `completedAt`, interrupted runs require `interruptedAt`. Specifically:
       ```
       const interruptedAt = isString(value.interruptedAt) ? value.interruptedAt : undefined;
       if (terminalStatus && !completedAt) return null;
       if (interruptedStatus && !interruptedAt) return null;
       ```
     - Preserve `resolvedProviderId` if present: `const resolvedProviderId = isContextProviderId(value.resolvedProviderId) ? value.resolvedProviderId : undefined;`
     - Include `interruptedAt` and `resolvedProviderId` in the returned record object.

2. In `src/shared/orchestrator-run-lifecycle.ts`:
   - Update `ALLOWED_RUN_TRANSITIONS` to allow interrupted transitions:
     ```
     queued: ["running", "interrupted"],
     running: ["completed", "failed", "interrupted"],
     completed: [],
     failed: [],
     interrupted: []
     ```
   - Update `isTerminalRunStatus` to include `"interrupted"`:
     `return status === "completed" || status === "failed" || status === "interrupted";`

3. In `src/shared/orchestrator-run-lifecycle.test.ts`:
   - Add test: "applies queued -> interrupted transition" (verify ok: true, status: "interrupted", timeline: ["queued", "interrupted"])
   - Add test: "applies running -> interrupted transition" (verify ok: true, status: "interrupted", timeline: ["queued", "running", "interrupted"])
   - Add test: "rejects interrupted -> running transition" (verify ok: false, reason contains "interrupted -> running")

4. In `src/shared/state.test.ts`:
   - Add test: "normalizes persisted interrupted run records through round-trip" with a run that has `status: "interrupted"`, `statusTimeline: ["queued", "running", "interrupted"]`, `interruptedAt: "2026-02-19T00:00:00.000Z"`, and `resolvedProviderId: "filesystem"`. Assert the run survives normalizeAppState, `interruptedAt` is preserved, `resolvedProviderId` is preserved.
   - Add test: "drops interrupted runs missing interruptedAt" with a run that has `status: "interrupted"` but no `interruptedAt` field. Assert the run is dropped (orchestratorRuns length 0).
  </action>
  <verify>
    `pnpm test -- src/shared/state.test.ts src/shared/orchestrator-run-lifecycle.test.ts` passes.
    `pnpm run desktop:typecheck` passes.
  </verify>
  <done>
    `"interrupted"` is a valid OrchestratorRunStatus. `interruptedAt` and `resolvedProviderId` fields exist on OrchestratorRunRecord. Normalization guards accept interrupted runs with `interruptedAt` and reject those without. Lifecycle transitions allow `queued->interrupted` and `running->interrupted`. All existing and new tests pass. Typecheck clean.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add context provenance projection to view model</name>
  <files>
    src/shared/orchestrator-run-view-model.ts
    src/shared/orchestrator-run-view-model.test.ts
  </files>
  <action>
1. In `src/shared/orchestrator-run-view-model.ts`:
   - Import `ContextProviderId` from `"../context/types"`.
   - Add new interface:
     ```typescript
     export interface OrchestratorRunContextProvenance {
       resolvedProviderId: ContextProviderId;
       snippetCount: number;
       fallbackFromProviderId?: ContextProviderId;
     }
     ```
   - Add optional `contextProvenance?: OrchestratorRunContextProvenance` field to `OrchestratorRunViewModel`.
   - Add `"interrupted"` case to `toStatusLabel` switch: return `"Interrupted"`.
   - In `projectOrchestratorRunViewModel`, after computing `contextPreview`, compute `contextProvenance`:
     ```typescript
     const contextProvenance: OrchestratorRunContextProvenance | undefined =
       run.resolvedProviderId
         ? {
             resolvedProviderId: run.resolvedProviderId,
             snippetCount: run.contextSnippets?.length ?? 0,
             fallbackFromProviderId:
               run.contextSnippets?.[0]?.provider !== run.resolvedProviderId
                 ? run.contextSnippets?.[0]?.provider
                 : undefined
           }
         : undefined;
     ```
   - Include `contextProvenance` in the returned view model object.

2. In `src/shared/orchestrator-run-view-model.test.ts`:
   - Add test: "labels interrupted runs as Interrupted" with a run that has `status: "interrupted"`, `statusTimeline: ["queued", "running", "interrupted"]`, `interruptedAt: "2026-02-19T00:00:00.000Z"`. Assert `statusLabel` is `"Interrupted"`.
   - Add test: "projects context provenance when resolvedProviderId is present" with a run that has `resolvedProviderId: "filesystem"` and `contextSnippets` with 2 snippets (both `provider: "filesystem"`). Assert `contextProvenance.resolvedProviderId` is `"filesystem"`, `snippetCount` is 2, `fallbackFromProviderId` is undefined.
   - Add test: "projects fallback provenance when snippet provider differs from resolved" with a run that has `resolvedProviderId: "mcp"` and a snippet with `provider: "filesystem"`. Assert `contextProvenance.fallbackFromProviderId` is `"filesystem"`.
   - Add test: "omits contextProvenance when resolvedProviderId is absent" for a run without `resolvedProviderId`. Assert `contextProvenance` is undefined.
  </action>
  <verify>
    `pnpm test -- src/shared/orchestrator-run-view-model.test.ts` passes.
    `pnpm run desktop:typecheck` passes.
  </verify>
  <done>
    `OrchestratorRunContextProvenance` interface exists. View model projects `contextProvenance` when `resolvedProviderId` is present, including snippet count and fallback indicator. `toStatusLabel` returns `"Interrupted"` for interrupted status. All existing and new tests pass. Typecheck clean.
  </done>
</task>

</tasks>

<verification>
- `pnpm test` passes (all shared contract tests green).
- `pnpm run desktop:typecheck` passes (no type errors from new fields or status values).
- Interrupted runs survive normalizeAppState round-trip.
- View model correctly labels and projects provenance for all status types.
</verification>

<success_criteria>
- `OrchestratorRunStatus` includes `"interrupted"` with proper lifecycle transitions.
- `OrchestratorRunRecord` has `interruptedAt`, `resolvedProviderId` optional fields.
- `normalizeOrchestratorRunRecord` correctly validates interrupted runs.
- `OrchestratorRunViewModel` includes `contextProvenance` and `"Interrupted"` label.
- All tests pass, typecheck clean.
</success_criteria>

<output>
After completion, create `.planning/phases/pending/07-resume-integrity-and-context-consistency/07-01-SUMMARY.md`
</output>
