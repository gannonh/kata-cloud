---
phase: 09-runtime-integration-and-esm-consolidation
plan: 02
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - package.json
  - src/main/provider-runtime/types.ts
  - src/main/provider-runtime/service.ts
  - src/main/provider-runtime/registry.ts
  - src/main/index.ts
  - src/shared/state.ts
  - src/main/provider-runtime/service.node.test.ts
autonomous: true

must_haves:
  truths:
    - "Runtime execution can be switched between native provider path and PI-backed path using explicit configuration."
    - "PI integration preserves existing shell/provider contracts and does not break fallback to native mode."
    - "PI mode selection is observable and testable without requiring invasive UI rewrites."
  artifacts:
    - path: "package.json"
      provides: "PI dependency additions and runtime-mode wiring support"
    - path: "src/main/provider-runtime/service.ts"
      provides: "Execution flow capable of native/PI routed provider calls"
    - path: "src/main/index.ts"
      provides: "Main-process runtime mode initialization and adapter registration"
  key_links:
    - from: "src/main/index.ts"
      to: "src/main/provider-runtime/registry.ts"
      via: "Runtime mode decides adapter registration path"
      pattern: "createProviderRuntimeRegistry"
    - from: "src/main/provider-runtime/service.ts"
      to: "src/shared/state.ts"
      via: "Execution mode/provenance can be surfaced and persisted in run diagnostics"
      pattern: "provider"
---

<objective>
Integrate PI runtime capabilities through a controlled adapter path with a reversible runtime-mode switch.

Purpose: Accelerate runtime evolution while maintaining v0.1 reliability and rollback safety.
Output: PI-backed adapter integration, mode selection, and compatibility tests.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/pending/09-runtime-integration-and-esm-consolidation/09-RESEARCH.md
@.planning/phases/pending/09-runtime-integration-and-esm-consolidation/09-01-PLAN.md
@package.json
@src/main/provider-runtime/types.ts
@src/main/provider-runtime/service.ts
@src/main/provider-runtime/registry.ts
@src/main/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Introduce explicit runtime mode contract and persistence surface</name>
  <files>
    src/main/provider-runtime/types.ts
    src/shared/state.ts
  </files>
  <action>
Define a minimal runtime-mode contract (`native` vs `pi`) and store/resolve it through existing configuration/state pathways without breaking current defaults. Keep the default mode native and preserve backwards compatibility for existing state payloads.
  </action>
  <verify>
    `pnpm test -- src/shared/state.test.ts src/main/provider-runtime/service.node.test.ts`
  </verify>
  <done>
    Runtime mode is typed, persisted or resolvable, and defaults safely to native behavior.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add PI-backed runtime adapter registration behind mode gate</name>
  <files>
    package.json
    src/main/provider-runtime/service.ts
    src/main/provider-runtime/registry.ts
    src/main/index.ts
  </files>
  <action>
Add PI package dependencies and implement adapter registration/routing so provider execution can flow through PI mode when selected, while preserving native adapter behavior unchanged otherwise. Keep provider IPC contracts stable.
  </action>
  <verify>
    `pnpm run desktop:typecheck`
  </verify>
  <done>
    Main process can boot with either runtime mode and execute provider requests without contract drift.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add regression coverage for native fallback and PI mode boundaries</name>
  <files>
    src/main/provider-runtime/service.node.test.ts
    src/main/index.ts
  </files>
  <action>
Extend runtime service tests to validate mode-specific behavior and fallback safety. Confirm native remains default, PI routing is explicit, and unsupported/misconfigured PI mode errors are actionable without destabilizing orchestrator lifecycle.
  </action>
  <verify>
    `pnpm test -- src/main/provider-runtime/service.node.test.ts src/main/provider-runtime/registry.node.test.ts`
  </verify>
  <done>
    PI integration is bounded, reversible, and guarded by deterministic tests.
  </done>
</task>

</tasks>

<verification>
1. `pnpm test -- src/main/provider-runtime/service.node.test.ts src/main/provider-runtime/registry.node.test.ts`
2. `pnpm run desktop:typecheck`
</verification>

<success_criteria>
- PI-01 and PI-02 are satisfied with adapter-first integration and explicit runtime switching.
- Existing provider IPC contracts remain stable for renderer/preload consumers.
- Native mode remains safe default with tested fallback behavior.
</success_criteria>

<output>
After completion, create `.planning/phases/pending/09-runtime-integration-and-esm-consolidation/09-02-SUMMARY.md`
</output>
