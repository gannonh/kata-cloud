---
phase: 09-runtime-integration-and-esm-consolidation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main.tsx
  - src/shared/state.ts
  - src/shared/orchestrator-run-view-model.ts
  - src/shared/orchestrator-run-view-model.test.ts
  - src/shared/shell-api.ts
autonomous: true

must_haves:
  truths:
    - "Orchestrator runs execute a real provider-backed generation path when credentials and model are available."
    - "Run records persist provider/model execution provenance and retain deterministic terminal lifecycle behavior."
    - "Provider runtime failures surface typed diagnostics without corrupting run or draft state."
  artifacts:
    - path: "src/main.tsx"
      provides: "Renderer orchestrator flow wired to provider execution path"
    - path: "src/shared/state.ts"
      provides: "Persisted run shape supports provider execution metadata"
    - path: "src/shared/orchestrator-run-view-model.ts"
      provides: "View model projection for provider execution telemetry"
  key_links:
    - from: "src/main.tsx"
      to: "src/shared/shell-api.ts"
      via: "onRunOrchestrator calls typed provider runtime IPC contracts"
      pattern: "providerExecute"
    - from: "src/main.tsx"
      to: "src/shared/state.ts"
      via: "Provider execution results/diagnostics persist on orchestrator run records"
      pattern: "orchestratorRuns"
---

<objective>
Replace local-only draft generation in orchestrator runs with provider-backed execution wiring while preserving deterministic lifecycle semantics.

Purpose: Make agent execution visibly real and close ORCH-01 for v0.2.
Output: Provider-backed run execution path, persisted telemetry fields, and projection coverage.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/pending/09-runtime-integration-and-esm-consolidation/09-RESEARCH.md
@src/main.tsx
@src/shared/state.ts
@src/shared/orchestrator-run-view-model.ts
@src/shared/shell-api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add provider-backed generation path to orchestrator run execution</name>
  <files>
    src/main.tsx
    src/shared/shell-api.ts
  </files>
  <action>
Refactor `onRunOrchestrator` to invoke typed provider execution for spec draft generation rather than relying only on `createSpecDraft` local synthesis. Keep existing context retrieval and lifecycle transitions intact (`queued -> running -> completed|failed`). Ensure provider selection/model inputs are explicit and failure-safe.
  </action>
  <verify>
    `pnpm test -- src/shared/orchestrator-run-view-model.test.ts`
  </verify>
  <done>
    Completed runs can include provider-generated output when runtime auth/model resolution succeeds, and failed runs preserve deterministic lifecycle and error handling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Persist provider execution telemetry on run records and project it for UI consumption</name>
  <files>
    src/shared/state.ts
    src/shared/orchestrator-run-view-model.ts
    src/shared/orchestrator-run-view-model.test.ts
  </files>
  <action>
Extend run-state contracts to capture provider/model execution metadata required for observability (provider id, model id, execution status/error context as needed). Update projection helpers and tests so telemetry can be rendered consistently in existing run cards/history before Phase 10 UI reshaping.
  </action>
  <verify>
    `pnpm test -- src/shared/state.test.ts src/shared/orchestrator-run-view-model.test.ts`
  </verify>
  <done>
    Run records and projections expose provider execution provenance with deterministic typing and test coverage.
  </done>
</task>

<task type="auto">
  <name>Task 3: Preserve deterministic failure behavior for provider execution errors</name>
  <files>
    src/main.tsx
    src/shared/state.ts
  </files>
  <action>
Ensure provider runtime failures map into existing typed error pathways and do not bypass run lifecycle guards. Keep fallback behavior explicit (no silent success synthesis), and preserve actionable diagnostics for downstream UX in Phases 10-12.
  </action>
  <verify>
    `pnpm run test:orchestrator-context`
  </verify>
  <done>
    Provider execution failure scenarios produce failed terminal runs with typed diagnostics and intact persisted history.
  </done>
</task>

</tasks>

<verification>
1. `pnpm run test:orchestrator-context`
2. `pnpm run desktop:typecheck`
</verification>

<success_criteria>
- ORCH-01 and ORCH-04 foundations are implemented in code, not mock-only run synthesis.
- Provider runtime behavior is visible in persisted run state and view-model projections.
- Existing deterministic orchestrator lifecycle guarantees remain intact.
</success_criteria>

<output>
After completion, create `.planning/phases/pending/09-runtime-integration-and-esm-consolidation/09-01-SUMMARY.md`
</output>
