---
phase: 05-orchestrator-lifecycle-determinism
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/shared/orchestrator-run-view-model.ts
  - src/shared/orchestrator-run-view-model.test.ts
  - src/shared/orchestrator-run-history.ts
  - src/shared/orchestrator-run-history.test.ts
autonomous: true
source_issue: github:#58
must_haves:
  truths:
    - Users see consistent delegated-task status and failure context for each run.
    - Run-history ordering and latest-run selection are deterministic for a session.
    - Renderer can consume pre-shaped run/task view data without duplicating status logic.
  artifacts:
    - src/shared/orchestrator-run-view-model.ts
    - src/shared/orchestrator-run-view-model.test.ts
    - src/shared/orchestrator-run-history.ts
    - src/shared/orchestrator-run-history.test.ts
  key_links:
    - View-model output composes run status, timeline, and delegated-task diagnostics from shared state records.
    - Run-history selector behavior remains stable and test-covered for newest-first rendering.
---

<objective>
Create deterministic run/task projection helpers so renderer views consume a single status model.

Purpose: Prevent divergent status/failure rendering logic and prepare clean parallel integration into `src/main.tsx`.
Output: Shared run view-model helper + updated run-history selectors/tests.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/pending/05-orchestrator-lifecycle-determinism/05-RESEARCH.md
@src/shared/orchestrator-run-history.ts
@src/shared/orchestrator-run-history.test.ts
@src/shared/state.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add run view-model projection helper for status and failure diagnostics</name>
  <files>src/shared/orchestrator-run-view-model.ts</files>
  <action>Create a shared projection module that transforms `OrchestratorRunRecord` and delegated tasks into renderer-friendly rows (status label, timeline string, actionable error text). Keep logic pure and deterministic; avoid UI formatting that belongs in JSX styling layers.</action>
  <verify>pnpm test -- orchestrator-run-view-model</verify>
  <done>Projection helper returns stable structures for completed, failed, and partially delegated runs with explicit error-context fields.</done>
</task>

<task type="auto">
  <name>Task 2: Add focused tests for projection edge cases</name>
  <files>src/shared/orchestrator-run-view-model.test.ts</files>
  <action>Add Vitest cases for: no delegated tasks, delegated failure chains, run-level failure with task-level completion mix, and empty/partial context snippets. Assert deterministic output fields that renderer will rely on.</action>
  <verify>pnpm test -- orchestrator-run-view-model</verify>
  <done>Test suite captures expected projection output for success/failure edge cases and prevents renderer regressions.</done>
</task>

<task type="auto">
  <name>Task 3: Tighten run-history selector ordering contract and tests</name>
  <files>src/shared/orchestrator-run-history.ts, src/shared/orchestrator-run-history.test.ts</files>
  <action>Refine session-history helpers to guarantee deterministic newest-first behavior (including tie-handling) and keep filtering scope strict to active space/session. Update tests to lock ordering/filter behavior used by run-history UI.</action>
  <verify>pnpm test -- orchestrator-run-history</verify>
  <done>Run-history selectors are deterministic under ordering ties and validated by dedicated tests.</done>
</task>

</tasks>

<verification>
1. Run `pnpm test -- orchestrator-run-view-model`.
2. Run `pnpm test -- orchestrator-run-history`.
</verification>

<success_criteria>
- Shared run/task projection helper exists with deterministic output contracts.
- Run-history selection/order logic is locked by tests and ready for renderer wiring.
- Delegated-task failure context can be rendered without re-implementing logic in `src/main.tsx`.
</success_criteria>

<output>
After completion, create `.planning/phases/pending/05-orchestrator-lifecycle-determinism/05-02-SUMMARY.md`
</output>
