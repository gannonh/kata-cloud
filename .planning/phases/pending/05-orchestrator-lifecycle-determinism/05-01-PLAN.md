---
phase: 05-orchestrator-lifecycle-determinism
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/shared/orchestrator-run-lifecycle.ts
  - src/shared/orchestrator-run-lifecycle.test.ts
  - src/shared/state.ts
autonomous: true
source_issue: github:#58
must_haves:
  truths:
    - Orchestrator run transitions are deterministic and do not skip invalid lifecycle states.
    - Run timelines always contain the terminal status shown in UI and persisted state.
    - Invalid lifecycle jumps are handled consistently instead of silently drifting state.
  artifacts:
    - src/shared/orchestrator-run-lifecycle.ts
    - src/shared/orchestrator-run-lifecycle.test.ts
    - src/shared/state.ts
  key_links:
    - Transition helper output aligns with OrchestratorRunStatus and statusTimeline contracts in src/shared/state.ts.
    - Lifecycle guard behavior is validated by focused Vitest coverage before renderer integration.
---

<objective>
Create deterministic run-lifecycle transition primitives in the shared domain layer.

Purpose: Remove lifecycle drift risk by centralizing status-transition rules before renderer wiring changes.
Output: New run-lifecycle helper module + tests + aligned state contract checks.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/pending/05-orchestrator-lifecycle-determinism/05-RESEARCH.md
@src/shared/state.ts
@src/shared/orchestrator-state.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add run lifecycle transition helper with explicit allowed transitions</name>
  <files>src/shared/orchestrator-run-lifecycle.ts</files>
  <action>Create a shared helper module that owns run transition semantics (`queued -> running -> completed|failed`) and timeline updates. Include deterministic handling for duplicate/invalid transitions (idempotent where safe, explicit guard return for invalid jumps). Keep helper API narrow and typed to `OrchestratorRunStatus`/`OrchestratorRunRecord` shape.</action>
  <verify>pnpm test -- orchestrator</verify>
  <done>Helper exposes typed transition function(s) with deterministic behavior for valid, duplicate, and invalid transitions.</done>
</task>

<task type="auto">
  <name>Task 2: Add focused lifecycle transition tests</name>
  <files>src/shared/orchestrator-run-lifecycle.test.ts</files>
  <action>Add Vitest coverage for valid transition progression, duplicate-status idempotency, and invalid jump handling. Ensure assertions verify both `status` and `statusTimeline` outcomes so downstream UI/state persistence stays consistent.</action>
  <verify>pnpm test -- orchestrator-run-lifecycle</verify>
  <done>Tests fail without helper logic and pass with deterministic lifecycle behavior across positive and negative paths.</done>
</task>

<task type="auto">
  <name>Task 3: Align state guard expectations with lifecycle helper invariants</name>
  <files>src/shared/state.ts</files>
  <action>Update run-record validation/normalization checks only as needed so they enforce lifecycle invariants used by the new helper (timeline non-empty, status present in timeline, terminal consistency). Do not broaden scope into unrelated state fields.</action>
  <verify>pnpm test -- state</verify>
  <done>Shared state validation accepts valid lifecycle records from helper output and rejects malformed lifecycle combinations consistently.</done>
</task>

</tasks>

<verification>
1. Run `pnpm test -- orchestrator` to confirm lifecycle-related suites stay green.
2. Run `pnpm test -- state` to ensure shared state normalization still behaves as expected.
</verification>

<success_criteria>
- Deterministic run-lifecycle helper exists and is covered by targeted tests.
- Lifecycle invariants are codified in shared state validation rather than ad-hoc renderer logic.
- Phase 5 can consume these transitions without re-defining status semantics.
</success_criteria>

<output>
After completion, create `.planning/phases/pending/05-orchestrator-lifecycle-determinism/05-01-SUMMARY.md`
</output>
