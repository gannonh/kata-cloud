---
phase: 06-delegation-context-contract-hardening
plan: 03
type: execute
wave: 2
depends_on:
  - "01"
  - "02"
files_modified:
  - src/shared/shell-api.ts
  - src/shared/context-ipc.ts
  - src/main/index.ts
  - src/preload/index.ts
  - src/preload/index.test.ts
  - src/main.tsx
  - src/shared/orchestrator-run-view-model.ts
  - src/shared/orchestrator-run-view-model.test.ts
autonomous: true
must_haves:
  truths:
    - Context retrieval failures surface actionable diagnostics in orchestrator run state and UI, not silent empty-snippet fallbacks.
    - Main/preload/renderer agree on one typed context contract across IPC boundaries.
    - Orchestrator run execution updates preserve prior history/session integrity while handling context failures deterministically.
  artifacts:
    - src/shared/shell-api.ts
    - src/shared/context-ipc.ts
    - src/main/index.ts
    - src/preload/index.ts
    - src/main.tsx
    - src/shared/orchestrator-run-view-model.ts
  key_links:
    - Main-process context retrieval failures serialize to shared IPC payloads that renderer can parse deterministically.
    - Renderer orchestration flow persists context diagnostics into run records via shared update helpers from Plan 02.
    - Run view-model projection includes context diagnostics used by latest-run and run-history UI sections.
---

<objective>
Integrate Phase 6 contracts into runtime orchestration flow so users can recover with clear diagnostics when context retrieval fails.

Purpose: Deliver user-visible hardening for CTX-02 and complete ORCH-03/ORCH-04 wiring by bridging context error contracts from main to renderer run history.
Output: Updated IPC contract + renderer integration that stores and displays context retrieval diagnostics with deterministic run-history behavior.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/pending/06-delegation-context-contract-hardening/06-RESEARCH.md
@.planning/phases/pending/06-delegation-context-contract-hardening/06-01-PLAN.md
@.planning/phases/pending/06-delegation-context-contract-hardening/06-02-PLAN.md
@src/shared/shell-api.ts
@src/main/index.ts
@src/preload/index.ts
@src/main.tsx
@src/shared/orchestrator-run-view-model.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire typed context retrieval contracts and IPC error serialization across shell boundary</name>
  <files>src/shared/shell-api.ts, src/shared/context-ipc.ts, src/main/index.ts, src/preload/index.ts, src/preload/index.test.ts</files>
  <action>Update shared shell contracts and preload/main handler wiring to use typed context retrieval outcomes and structured context error serialization/parsing. Follow the provider-runtime IPC contract pattern so renderer receives stable error payload fields (code/message/remediation/retryable/provider). Keep channel names unchanged and preload parity test coverage green.</action>
  <verify>pnpm test -- preload && pnpm run desktop:typecheck</verify>
  <done>IPC boundary transmits typed context success/failure information deterministically and preload channel parity remains intact.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate run-persistence helper usage and context diagnostics capture in orchestrator flow</name>
  <files>src/main.tsx</files>
  <action>Refactor `onRunOrchestrator` flow to use Plan 02 run-persistence helpers for queued/running/terminal updates and to persist context retrieval diagnostics when retrieval fails. Preserve deterministic lifecycle transitions and ensure failures do not corrupt active session/spec linkage. Avoid broad unrelated refactors outside orchestrator run flow blocks.</action>
  <verify>pnpm test -- orchestrator && pnpm test -- state</verify>
  <done>Orchestrator flow records context failure diagnostics and applies deterministic run updates without broad snapshot corruption risk.</done>
</task>

<task type="auto">
  <name>Task 3: Project and render actionable context diagnostics for latest run and history</name>
  <files>src/shared/orchestrator-run-view-model.ts, src/shared/orchestrator-run-view-model.test.ts, src/main.tsx</files>
  <action>Extend run view-model projection to include context retrieval diagnostic messaging and ensure both latest-run and prior-run sections display actionable failure context. Add/adjust tests that validate deterministic diagnostic projection for successful and failed context retrieval scenarios.</action>
  <verify>pnpm test -- orchestrator-run-view-model</verify>
  <done>Users can reopen historical runs and clearly see context retrieval failure cause/remediation instead of generic "no snippets" fallback behavior.</done>
</task>

</tasks>

<verification>
1. Run `pnpm test -- preload`.
2. Run `pnpm test -- orchestrator-run-view-model`.
3. Run `pnpm test -- state`.
4. Run `pnpm run desktop:typecheck`.
</verification>

<success_criteria>
- CTX-02 delivered: context/provider failures surface actionable diagnostics in run state and UI.
- Main/preload/renderer context retrieval contracts are type-aligned and serialization-safe.
- ORCH-03/ORCH-04 run-history behavior remains deterministic and recoverable under failure paths.
</success_criteria>

<output>
After completion, create `.planning/phases/pending/06-delegation-context-contract-hardening/06-03-SUMMARY.md`
</output>
