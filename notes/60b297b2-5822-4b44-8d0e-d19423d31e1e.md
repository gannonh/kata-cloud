---
id: 60b297b2-5822-4b44-8d0e-d19423d31e1e
title: Define enforceable coverage scope and command path
parent: spec
created: "2026-02-16T19:49:10.354Z"
task:
  status: complete
  peerOrder: 300
  startedAt: "2026-02-16T20:04:40.926Z"
  assignedAgentIds: [agent-90439f92-4800-4fb5-96df-6396c5c1307f]
  completedAt: "2026-02-16T20:25:02.696Z"
---

# Define enforceable coverage scope and command path

Ensure coverage gating executes deterministically and targets the intended code surface without lowering thresholds.

## Scope
In scope: `vitest.config.ts` coverage include/exclude/reporter configuration and command-path alignment documentation.
Out of scope: lowering thresholds below `80/70/80/80`.

## Inputs
- [Spec](intent://local/note/spec)
- [Coverage enforcement task](intent://local/task/b5b5509f-53b0-46b8-93aa-53e65fd88711)
- [Wave 1.5 final verifier](intent://local/task/e7be8fb9-0d21-4a8b-9cfd-0ad2686a3f77)

## Definition of Done
- Coverage runs via a single deterministic path used by local and CI gates.
- Coverage scope rules are explicit and justified in the task note.
- Threshold enforcement remains `statements 80`, `branches 70`, `functions 80`, `lines 80`.

## Verification
- `pnpm run test --coverage`
- Inspect `vitest.config.ts` and `.github/workflows/ci-quality-gates.yml` for path/scope alignment

## Completion Evidence (Turn 2)

### Exact `vitest.config.ts` diff summary
Only `vitest.config.ts` was changed for this task.

- Added `test.coverage` config block.
- Set provider/report output path:
  - `provider: "v8"`
  - `reporter: ["text", "json-summary"]`
  - `reportsDirectory: "./coverage"`
- Added explicit deterministic scope:
  - `include`: `src/**/*.{ts,tsx}`, `packages/task-parser/src/**/*.js`
  - `exclude`: `src/main.tsx`, `src/main/**`, `src/preload/**`, `src/test/**`, `**/*.d.ts`, `**/*.test.{ts,tsx,js,jsx}`, `**/*.node.test.{ts,tsx,js,jsx}`
- Kept thresholds unchanged:
  - `statements: 80`
  - `branches: 70`
  - `functions: 80`
  - `lines: 80`

### Deterministic command-path alignment (local + CI)
- Local command path used: `pnpm run test --coverage`
- CI workflow command path: `.github/workflows/ci-quality-gates.yml` line 36 -> `run: pnpm run test --coverage`
- Script resolution in `package.json`:
  - `"test": "vitest run"`
  - therefore `pnpm run test --coverage` resolves to `vitest run --coverage` in both local and CI.

### Fresh verification evidence
Command run:
- `pnpm run test --coverage`

Result (fresh run):
- Exit code: `1` (expected for current failing thresholds)
- Tests: `13 passed`, `35 passed`
- Global coverage totals:
  - Statements: `75.67%`
  - Branches: `72.30%`
  - Functions: `83.07%`
  - Lines: `75.67%`
- Threshold enforcement remains active and unchanged:
  - `ERROR: Coverage for lines (75.67%) does not meet global threshold (80%)`
  - `ERROR: Coverage for statements (75.67%) does not meet global threshold (80%)`

### Artifact cleanup confirmation
Coverage artifacts removed after verification:
- Removed: `coverage/coverage-summary.json`
- Removed: `coverage/` directory
- Verified absent from working tree.

### Files changed in this task
- `vitest.config.ts`

### Commands executed in this task
- `pnpm run test --coverage`
- `rg -n "run: pnpm run test --coverage|\"test\"\s*:\s*\"vitest run\"" .github/workflows/ci-quality-gates.yml package.json`
- `/bin/rm -f coverage/coverage-summary.json`
- `/bin/rmdir coverage`
- `git diff -- vitest.config.ts`
- `git status --short`

## Verifier Checkpoint (2026-02-16)

Checkpoint scope: Wave 1.6 Wave 2 Task 1 verification-only.

Result summary:
- `vitest.config.ts` thresholds are unchanged and enforced at `statements: 80`, `branches: 70`, `functions: 80`, `lines: 80` (lines 25-29).
- Deterministic command path is aligned in working tree:
  - `package.json` script is `"test": "vitest run"` (line 13).
  - `.github/workflows/ci-quality-gates.yml` runs `pnpm run test --coverage` (line 36).
- Executed `pnpm run test --coverage` locally; command exited `1` due threshold failures, confirming enforcement is active:
  - `ERROR: Coverage for lines (75.67%) does not meet global threshold (80%)`
  - `ERROR: Coverage for statements (75.67%) does not meet global threshold (80%)`
- Post-run artifact hygiene verified:
  - `coverage/coverage-summary.json` and `coverage/` were removed.
  - `git status --short -- coverage coverage/coverage-summary.json` returned no entries.

Consistency assessment:
- Task note evidence remains internally coherent for scope/threshold/path intent.
- Noted workspace state risk: `.github/` is currently untracked in this working tree, so CI-path alignment evidence is present in files but not yet anchored by a committed workflow file in this branch snapshot.