---
id: d9a13fa0-1e1a-487b-81e7-e0e41fa9c948
title: Stabilize Electron dev startup orchestration
parent: spec
created: "2026-02-16T18:06:39.866Z"
task:
  status: complete
  peerOrder: 100
  startedAt: "2026-02-16T18:15:09.102Z"
  assignedAgentIds: [agent-fc78709d-05c2-4671-a4d5-0b4bf155e85d]
  completedAt: "2026-02-16T18:27:01.593Z"
---

# Stabilize Electron dev startup orchestration

Eliminate startup sequencing fragility between Vite and Electron so local dev boot is deterministic and no longer tied to a stale fixed-port wait condition.

## Scope
In scope: `package.json` dev/start scripts, startup wait strategy, and minimal runtime wiring needed so Electron launches against the correct renderer endpoint.
Out of scope: product feature/UI behavior changes.

## Inputs
[Spec](intent://local/note/spec)
Runtime remediation note: [Unblock Electron runtime install for dev startup](intent://local/task/fe99cd34-6c78-45e5-b3b2-a60cebae3faf)
Verifier rerun note: [Re-run Wave 1 gate after runtime remediation](intent://local/task/87853fc8-3e92-428e-95da-239cbb11d698)

## Definition of Done
- Dev startup no longer depends on a brittle fixed `wait-on tcp:5173` assumption when Vite port selection changes.
- `pnpm run dev` reaches a stable launch path in a normal local environment (or fails with a clear, deterministic non-app blocker).
- Startup behavior and any new constraints are documented in task evidence.

## Verification
- `pnpm run dev`
- Optional contention check: occupy port `5173`, then `pnpm run dev` again and verify deterministic behavior.

## Summary (Turn 1)
Implemented startup orchestration stabilization by replacing the fixed `wait-on tcp:5173` dev flow with a deterministic launcher script. The new launcher reads Vite’s actual local URL and sets `KATA_CLOUD_RENDERER_URL` for Electron, so Electron targets the selected Vite port even when `5173` is occupied.

## Acceptance Criteria
- [x] Dev startup no longer depends on fixed `wait-on tcp:5173` coupling.
- [x] `pnpm run dev` follows a deterministic launch path in normal startup and `5173` contention startup.
- [x] Startup behavior, command evidence, and residual risks are recorded.

## Subtasks
- None.

## References
- `package.json`
- `bin/dev-desktop.mjs`

## Learnings
- Parsing Vite’s `Local:` log line and exporting `KATA_CLOUD_RENDERER_URL` is a minimal way to remove fixed-port coupling without product/UI changes.
- In this environment, Electron GUI startup still aborts with `SIGABRT`; this is a deterministic downstream blocker after orchestration completes.

## Changes
- `package.json`
  - Changed `dev` script from fixed `wait-on tcp:5173` orchestration to `node bin/dev-desktop.mjs`.
- `bin/dev-desktop.mjs`
  - Added deterministic dev launcher that:
    - runs `desktop:build-main`
    - starts Vite on preferred port `5173`
    - parses Vite output for actual `Local` URL
    - waits for `/__vite_ping` readiness on discovered URL
    - launches Electron with `KATA_CLOUD_RENDERER_URL=<discovered-url>`
    - shuts down sibling process on exit/signals

## Verification Evidence
1. `pnpm run dev`
```text
> kata-cloud@0.0.0 dev /Users/gannonhall/intent/workspaces/following-build-2/kata-cloud
> node bin/dev-desktop.mjs

> kata-cloud@0.0.0 desktop:build-main /Users/gannonhall/intent/workspaces/following-build-2/kata-cloud
> tsc -p tsconfig.main.json

  VITE v6.4.1  ready in 73 ms

  ➜  Local:   http://127.0.0.1:5173/
[dev] Launching Electron with renderer URL: http://127.0.0.1:5173
.../electron/dist/Electron.app/Contents/MacOS/Electron exited with signal SIGABRT
```
Result: deterministic renderer URL selection on normal startup; Electron GUI abort remains.

2. `5173` contention scenario
Command:
```text
node -e 'require("node:http").createServer((_,res)=>res.end("occupied")).listen(5173,"127.0.0.1"); setInterval(() => {}, 1000);' >/tmp/kata-port-5173.log 2>&1 & PORT_PID=$!; trap 'kill ${PORT_PID} 2>/dev/null || true' EXIT; sleep 1; pnpm run dev
```
Output:
```text
zsh:1: nice(5) failed: operation not permitted

> kata-cloud@0.0.0 dev /Users/gannonhall/intent/workspaces/following-build-2/kata-cloud
> node bin/dev-desktop.mjs

> kata-cloud@0.0.0 desktop:build-main /Users/gannonhall/intent/workspaces/following-build-2/kata-cloud
> tsc -p tsconfig.main.json

Port 5173 is in use, trying another one...

  VITE v6.4.1  ready in 77 ms

  ➜  Local:   http://127.0.0.1:5174/
[dev] Launching Electron with renderer URL: http://127.0.0.1:5174
.../electron/dist/Electron.app/Contents/MacOS/Electron exited with signal SIGABRT
```
Result: deterministic startup under port contention; launcher correctly follows Vite-selected `5174` instead of stale `5173`.

## Residual Risks
- Electron GUI startup still exits with `SIGABRT` in this environment; this appears downstream of startup URL orchestration and remains for follow-up verification/remediation.
- Port-contention harness logs `zsh:1: nice(5) failed: operation not permitted` before command output; this did not block contention test execution.

## Summary (Turn 2)
No additional code changes were required after recovery. Scoped startup-stabilization changes were committed as `297fd5a` (`Stabilize dev startup renderer URL orchestration`).

## Changes (Turn 2)
- Commit: `297fd5a`
- Files in commit: `package.json`, `bin/dev-desktop.mjs`
- Unrelated workspace file left untouched: `AGENTS.md` (untracked, out of task scope).

## Final Close-out (Turn 3)
- Commit finalized: `297fd5a` (`Stabilize dev startup renderer URL orchestration`).
- Commit scope verified: only `package.json` and `bin/dev-desktop.mjs`.
- `AGENTS.md` remains untracked and excluded from task commit scope.
- Final evidence status: startup orchestration is deterministic for both normal startup (`5173`) and contention startup (`5174`) via discovered Vite URL handoff to Electron (`KATA_CLOUD_RENDERER_URL`), with remaining deterministic downstream blocker `SIGABRT` documented above.