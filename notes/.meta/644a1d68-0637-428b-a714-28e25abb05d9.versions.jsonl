{"type":"snapshot","v":1,"date":"2026-02-17T00:38:44.917Z","author":{"id":"user","name":"User","type":"user"},"content":"# Fix deterministic failure-path trigger and error surfacing\n\nMake orchestrator runs fail deterministically when the configured failure trigger is present, and surface actionable failure information in the UI.\n\n## Scope\nIn scope: failure-trigger evaluation in orchestrator run execution, failed lifecycle/terminal state handling, and visible failure messaging in orchestrator status.\nOut of scope: provider runtime/auth, GitHub PR workflow, browser preview, context adapter work.\n\n## Inputs\n- [Spec](intent://local/note/spec)\n- [Ship orchestrator planning loop and specialist task delegation](intent://local/task/55f46e5e-e243-4efc-971b-fd5cd1504a85)\n\n## Definition of Done\n- A prompt containing the configured failure trigger results in run lifecycle `queued -> running -> failed`.\n- Failure state includes actionable error text in orchestrator status UI.\n- Failure path does not corrupt existing spec content.\n\n## Verification\n- `pnpm run desktop:typecheck`\n- `pnpm test -- orchestrator`\n- Manual: run prompt containing trigger keyword and confirm failed terminal state + error copy\n\n## Summary (Turn 2)\nImplemented deterministic failure trigger detection for the `fail` keyword (case-insensitive, word-boundary), wired it into orchestrator run execution, and surfaced actionable failure guidance in the run error message. Added focused unit tests and validated orchestrator suite + desktop typecheck.\n\n## Acceptance Criteria\n- [x] Prompt containing configured deterministic trigger forces terminal run status to `failed` with lifecycle `queued -> running -> failed`.\n- [x] Failure details are surfaced in orchestrator status UI with actionable message text.\n- [x] Failure path leaves spec content unchanged.\n- [x] `pnpm test -- orchestrator` and `pnpm run desktop:typecheck` pass.\n\n## Subtasks\n- [x] None delegated.\n\n## References\n- `spec` Wave 2.1 UAT case 4 failure evidence.\n- `src/main.tsx`\n- `src/shared/orchestrator-failure.ts`\n- `src/shared/orchestrator-failure.test.ts`\n\n## Learnings\n- Root cause: deterministic trigger contract drifted (`run-fail` in code vs `fail` used in UAT). Centralizing trigger detection in a shared utility makes behavior explicit and testable.\n\n## Changes\n- `src/main.tsx`: replaced inline failure-trigger logic with shared `resolveRunFailure` import.\n- `src/shared/orchestrator-failure.ts`: added deterministic trigger detection and actionable failure-message resolver.\n- `src/shared/orchestrator-failure.test.ts`: added focused tests for trigger matching and failure-message behavior.\n\n## Turn Counter\n- Turn 2\n\n```ws-block:cli\n{\n  \"id\": \"aaecdae7-423b-4d87-a393-e77ac1776890\",\n  \"version\": 1,\n  \"type\": \"cli\",\n  \"createdAt\": \"2026-02-17T00:33:40.573Z\",\n  \"createdBy\": \"agent\",\n  \"command\": \"pnpm test -- orchestrator\",\n  \"description\": \"Run orchestrator-focused tests\",\n  \"cwd\": \"/Users/gannonhall/intent/workspaces/following-build-2/kata-cloud\",\n  \"display\": {\n    \"showCommandPrefix\": \"$\"\n  }\n}\n```\n\n```ws-block:cli\n{\n  \"id\": \"4964289a-3ee9-48f3-ac95-7dd6ff3ae307\",\n  \"version\": 1,\n  \"type\": \"cli\",\n  \"createdAt\": \"2026-02-17T00:33:40.607Z\",\n  \"createdBy\": \"agent\",\n  \"command\": \"pnpm run desktop:typecheck\",\n  \"description\": \"Typecheck desktop main+renderer\",\n  \"cwd\": \"/Users/gannonhall/intent/workspaces/following-build-2/kata-cloud\",\n  \"display\": {\n    \"showCommandPrefix\": \"$\"\n  }\n}\n```","title":"Fix deterministic failure-path trigger and error surfacing"}
