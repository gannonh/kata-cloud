{"type":"snapshot","v":1,"date":"2026-02-16T23:50:27.321Z","author":{"id":"user","name":"User","type":"user"},"content":"# Implement spec-draft synthesis from orchestrator runs\n\nGenerate and persist a draft spec payload from orchestrator context so users can review/edit proposed plan content.\n\n## Scope\nIn scope: deterministic spec-draft generation path, write/update integration with spec note flow, and UI visibility of latest draft result.\nOut of scope: advanced prompt optimization and multi-model routing.\n\n## Inputs\n- [Spec](intent://local/note/spec)\n- [Build spec note panel with autosave and comment threads](intent://local/task/43a5ba09-1e2b-43db-b354-4d90a46f1cdf)\n- [Ship orchestrator planning loop and specialist task delegation](intent://local/task/55f46e5e-e243-4efc-971b-fd5cd1504a85)\n\n## Definition of Done\n- Successful runs produce a structured spec-draft artifact tied to run id.\n- User can apply/update draft content through existing spec note pathway.\n- Failure states are surfaced without corrupting existing spec content.\n\n## Verification\n- `pnpm run desktop:typecheck`\n- `pnpm test -- notes`\n- `pnpm test -- orchestrator`\n\n## Implementation Update (Turn 1)\n\n### Summary\nImplemented deterministic spec-draft synthesis in the orchestrator run-completion path, persisted the draft artifact on the run record, and wired draft apply through the existing spec note save path with explicit success/failure surfacing tied to run id.\n\n### Acceptance Criteria\n- ✅ Completed orchestrator runs produce a structured draft artifact tied to run id.\n- ✅ User can apply/update draft content through existing spec note pathway.\n- ✅ Failure states are surfaced and do not corrupt current spec content.\n\n### Changes\n- `src/shared/state.ts`\n  - Added `OrchestratorSpecDraft` and run-level draft fields (`draft`, `draftAppliedAt`, `draftApplyError`).\n  - Extended run normalization/validation to persist only valid draft artifacts.\n- `src/main.tsx`\n  - Added deterministic `createSpecDraft` synthesis and attached draft to completed runs.\n  - Added draft-apply result persistence (`applied`/`failed`) on run records.\n  - Passed latest run draft artifact into `SpecNotePanel` and surfaced draft/apply status in Orchestrator UI bound to run id.\n- `src/features/spec-panel/spec-note-panel.tsx`\n  - Added draft card for incoming orchestrator artifact and `Apply Draft to Spec` action.\n  - Reused existing `saveSpecNote(...)` path to apply draft content.\n  - Added explicit failure message path when draft apply write fails.\n- `src/features/spec-panel/spec-note-panel.test.tsx`\n  - Added tests for successful draft apply and failed draft apply preserving current content.\n- `src/shared/orchestrator-state.test.ts`\n  - Extended normalization coverage for valid draft retention and invalid draft rejection.\n\n### Verification\n- `pnpm run desktop:typecheck` -> PASS\n  - Evidence: `tsc --noEmit -p tsconfig.main.json && tsc --noEmit -p tsconfig.renderer.json` exited 0.\n- `pnpm test -- notes` -> PASS\n  - Evidence: `Test Files 15 passed`, `Tests 44 passed`.\n- `pnpm test -- orchestrator` -> PASS\n  - Evidence: `Test Files 15 passed`, `Tests 44 passed`.\n\n### DoD Claim Mapping\n1. **Structured draft artifact tied to run id**: satisfied via persisted `draft` object on `OrchestratorRunRecord` with `runId` and deterministic generated content on completed runs.\n2. **Apply/update through existing spec pathway**: satisfied via `SpecNotePanel` draft apply using `saveSpecNote(...)` (existing write/update path).\n3. **Failure surfaced without corrupting current spec**: satisfied via explicit draft-apply failure status in panel + run record, with spec content unchanged when storage write fails.\n\n### Residual Risks\n- Draft template is intentionally deterministic/minimal; quality/content richness is limited by scope.\n- Draft-apply race behavior relies on current in-memory `state` snapshot in `onSpecDraftApplied`; concurrent run updates in future may need a reducer-style state merge.\n\n## Verification Update (Turn 2 - Verifier)\n\n### Scope\nWave 2.1 Task 2 only: `Implement spec-draft synthesis from orchestrator runs`.\n\n### Severity-ranked findings\n- P0: None.\n- P1: None.\n- P2: None blocking DoD. Existing deprecation warning in tests (`ReactDOMTestUtils.act`) observed, but unrelated to this task's acceptance criteria.\n\n### DoD verification\n1. **Completed runs produce structured draft artifact tied to run id** — **VERIFIED**\n   - Evidence: `createSpecDraft` binds `runId` onto draft payload and completion path stores `draft` on ended run record in `src/main.tsx:104`, `src/main.tsx:468`, `src/main.tsx:474`.\n   - Evidence: Run/draft schema persisted in shared state model via `OrchestratorSpecDraft` and `OrchestratorRunRecord.draft` in `src/shared/state.ts:11`, `src/shared/state.ts:37`, `src/shared/state.ts:48`.\n   - Evidence: normalization test keeps valid draft and lifecycle timeline in `src/shared/orchestrator-state.test.ts:5`.\n\n2. **User can apply/update draft via existing spec note pathway** — **VERIFIED**\n   - Evidence: Spec panel applies draft by calling existing `saveSpecNote(...)` persistence path in `src/features/spec-panel/spec-note-panel.tsx:121`, `src/features/spec-panel/spec-note-panel.tsx:134`.\n   - Evidence: orchestrator draft is passed to same Spec panel surface from app shell in `src/main.tsx:1079`.\n   - Evidence: apply success test asserts persisted spec content and callback status in `src/features/spec-panel/spec-note-panel.test.tsx:119`.\n\n3. **Failure surfaced and does not corrupt existing spec content** — **VERIFIED**\n   - Evidence: draft apply failure path sets explicit UI failure status and propagates failed result callback in `src/features/spec-panel/spec-note-panel.tsx:139`.\n   - Evidence: orchestrator view renders run error and draft-apply error messages tied to latest run in `src/main.tsx:992`, `src/main.tsx:995`.\n   - Evidence: failure test verifies error surfaced and editor content remains unchanged after failed apply in `src/features/spec-panel/spec-note-panel.test.tsx:143`.\n\n### Out-of-scope check\nNo provider runtime, multi-model routing, PR workflow, browser preview, or context-adapter implementation was introduced in task-scoped changes (`src/main.tsx`, `src/shared/state.ts`, `src/features/spec-panel/*`, `src/shared/orchestrator-state.test.ts`).\n\n### Commands run\n- `pnpm run desktop:typecheck` → PASS\n- `pnpm test -- notes` → PASS\n- `pnpm test -- orchestrator` → PASS\n\n### GO/NO-GO\n**GO** for Wave 2.1 Task 2.","title":"Implement spec-draft synthesis from orchestrator runs"}
