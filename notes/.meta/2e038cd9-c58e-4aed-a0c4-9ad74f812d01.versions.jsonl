{"type":"snapshot","v":1,"date":"2026-02-16T20:00:18.173Z","author":{"id":"user","name":"User","type":"user"},"content":"# Fix GitCli mock typing mismatches in tests\n\nCorrect test doubles so strict typing no longer fails with `TS2739` in git service tests.\n\n## Scope\nIn scope: `src/git/space-git-service.node.test.ts`, `src/git/space-git-service.test.ts`, and minimal local test helper/type updates needed.\nOut of scope: production git behavior changes.\n\n## Inputs\n- [Spec](intent://local/note/spec)\n- [Wave 1.5 final verifier](intent://local/task/e7be8fb9-0d21-4a8b-9cfd-0ad2686a3f77)\n\n## Definition of Done\n- `TS2739` mock/type mismatch errors are removed.\n- Test behavior assertions remain intact.\n- Task note includes before/after typecheck evidence.\n\n## Verification\n- `pnpm run desktop:typecheck`\n- `pnpm run test -- git`\n\n\n## Summary (Turn 1)\nPreparing minimal test-only typing fixes for GitCli mock TS2739 errors in the two scoped git service test files.\n\n## Acceptance Criteria\n- [x] `pnpm run desktop:typecheck` no longer reports TS2739 mismatches for GitCli mocks in scoped git service tests.\n- [x] `pnpm run test -- git` passes after the typing fixes.\n- [x] Only test-side typing updates are made in scope files.\n- [x] Task note includes exact file diff and before/after command evidence.\n\n## References\n- `src/git/space-git-service.node.test.ts`\n- `src/git/space-git-service.test.ts`\n\n## Learnings\n- `GitCli` is a class with private members, so plain object mocks no longer structurally satisfy `GitCli`; test helpers need an explicit cast for mock objects.\n\n## Changes\n- `src/git/space-git-service.node.test.ts`: imported `type GitCli`, changed `createFakeGit` return type to `GitCli`, and cast helper return object as `unknown as GitCli`.\n- `src/git/space-git-service.test.ts`: imported `type GitCli`, changed `createFakeGit` return type to `GitCli`, and cast helper return object as `unknown as GitCli`.\n\n\n## Summary (Turn 2)\nImplemented minimal test-only typing updates for `GitCli` mocks in the two scoped test files. No production git files were changed.\n\n## Verification Evidence\n\n### Before\n- `pnpm run desktop:typecheck` (exit 2)\n  - `src/git/space-git-service.node.test.ts(43,5): error TS2739 ... missing ... commandRunner, assertSuccess`\n  - `src/git/space-git-service.node.test.ts(68,5): error TS2739 ... missing ... commandRunner, assertSuccess`\n  - `src/git/space-git-service.test.ts(62,7): error TS2739 ... missing ... commandRunner, assertSuccess`\n  - `src/git/space-git-service.test.ts(93,7): error TS2739 ... missing ... commandRunner, assertSuccess`\n  - `src/git/space-git-service.test.ts(107,7): error TS2739 ... missing ... commandRunner, assertSuccess`\n  - `src/git/space-git-service.test.ts(126,7): error TS2739 ... missing ... commandRunner, assertSuccess`\n- `pnpm run test -- git` (exit 0)\n\n### After\n- `pnpm run desktop:typecheck` (exit 0)\n- `pnpm run test -- git` (exit 0)\n\n## Exact File Diff\n```diff\ndiff --git a/src/git/space-git-service.node.test.ts b/src/git/space-git-service.node.test.ts\nindex 9cdd973..7b91ba8 100644\n--- a/src/git/space-git-service.node.test.ts\n+++ b/src/git/space-git-service.node.test.ts\n@@ -1,9 +1,10 @@\n import assert from \"node:assert/strict\";\n import { test } from \"vitest\";\n+import type { GitCli } from \"./git-cli\";\n import { SpaceGitLifecycleService } from \"./space-git-service\";\n import { createSpaceGitRequest } from \"./types\";\n \n-function createFakeGit(overrides = {}) {\n+function createFakeGit(overrides = {}): GitCli {\n   return {\n@@ -24,7 +25,7 @@ function createFakeGit(overrides = {}) {\n       return \"kata-space/feature-space1\";\n     },\n     ...overrides\n-  };\n+  } as unknown as GitCli;\n }\n \n function createRequest() {\ndiff --git a/src/git/space-git-service.test.ts b/src/git/space-git-service.test.ts\nindex 129102f..7e2fca1 100644\n--- a/src/git/space-git-service.test.ts\n+++ b/src/git/space-git-service.test.ts\n@@ -1,4 +1,5 @@\n import { describe, expect, it } from \"vitest\";\n+import type { GitCli } from \"./git-cli\";\n import { SpaceGitLifecycleService } from \"./space-git-service\";\n import {\n   createSpaceGitRequest,\n@@ -20,7 +21,7 @@ function createFakeGit(\n     switchBranch: (worktreePath: string, branchName: string) => Promise<void>;\n     currentBranch: (worktreePath: string) => Promise<string>;\n   }> = {}\n-) {\n+) : GitCli {\n   return {\n@@ -41,7 +42,7 @@ function createFakeGit(\n       return \"kata-space/feature-1234\";\n     },\n     ...overrides\n-  };\n+  } as unknown as GitCli;\n }\n \n function createBaseRequest(): SpaceGitLifecycleRequest {\n```","title":"Fix GitCli mock typing mismatches in tests"}
