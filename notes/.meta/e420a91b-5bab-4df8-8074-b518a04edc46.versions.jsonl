{"type":"snapshot","v":1,"date":"2026-02-16T15:26:16.556Z","author":{"id":"user","name":"User","type":"user"},"content":"# Enforce one-block-one-task for duplicate titles and normalize parser module boundary\n\nFix parser edge cases where duplicate task titles collapse into one record, and ensure parser module boundary works cleanly in current runtime/tooling.\n\n## Scope\nIn scope: `packages/task-parser/src/task-sync.js`, `packages/task-parser/src/index.js`, parser tests, and minimal package metadata if needed.\nOut of scope: non-parser feature behavior.\n\n## Inputs\n[Spec](intent://local/note/spec)\nTask note: [Implement task block parsing and task-note conversion](intent://local/task/91331c4e-10c7-42cd-97be-7c63b6edfc35)\nVerifier findings from `agent-5ee006d8-f4c1-4078-b2ae-19debd9f9ef8` and `agent-7cc2f25e-ce63-44d9-a9a1-da4f58d082d3`.\n\n## Definition of Done\n- Two `\n\n## Summary (Turn 1)\nImplemented parser-only remediation for duplicate-title cardinality and parser module boundary normalization. `syncTaskBlocks` now always provides an explicit ID for new block conversions, preventing title-collapsing stores from merging distinct `@@@task` blocks. Added a duplicate-title regression test and parser-local package metadata so Node treats parser sources as ESM under the repo’s CommonJS root.\n\n## Acceptance Criteria\n- ✅ Duplicate `@@@task` blocks with the same title produce distinct task records (one block -> one task).\n- ✅ Parser package module boundary is normalized for runtime import (`packages/task-parser/package.json` with `\"type\": \"module\"`).\n- ✅ Regression coverage added for duplicate-title collapse risk.\n- ⚠️ Full Vitest suite execution remains blocked in this environment (missing `node_modules`/`vitest`).\n\n## References\n- `packages/task-parser/src/task-sync.js`\n- `packages/task-parser/test/task-parser.test.js`\n- `packages/task-parser/package.json`\n\n## Learnings\n- In mixed-module repos, a nested parser package needs its own module boundary declaration to keep ESM parser sources executable under Node.\n- One-block-one-task behavior must not rely on title-only `upsert` behavior in downstream stores.\n\n## Changes\n- `packages/task-parser/src/task-sync.js`: set `upsert` input `id` to `existingTask?.id ?? randomUUID()` to force distinct IDs for new block conversions.\n- `packages/task-parser/test/task-parser.test.js`: added regression test simulating a title-collapsing store and asserting duplicate-title blocks stay distinct.\n- `packages/task-parser/package.json`: added parser-local metadata with `\"type\": \"module\"` and entry export.\n\n## Verification Results\n- `pnpm run test -- task-parser` -> **FAIL** (`vitest: command not found`; `node_modules` missing).\n- `node --input-type=module -e \"import('./packages/task-parser/src/index.js').then((m)=>console.log('exports',Object.keys(m).sort().join(',')))\"` -> **PASS** (`exports checkboxForStatus,createInMemoryTaskStore,normalizeTaskTitle,parseTaskBlocks,parseTaskLinks,syncTaskBlocks`).\n- `node --input-type=module <<'EOF' ... duplicate-title smoke ... EOF` -> **PASS** (`duplicate-title smoke: PASS`).\n\n```ws-block:cli\n{\n  \"id\": \"953375aa-489e-4f61-b007-7cb22783de8b\",\n  \"version\": 1,\n  \"type\": \"cli\",\n  \"createdAt\": \"2026-02-16T15:21:16.462Z\",\n  \"createdBy\": \"agent\",\n  \"command\": \"pnpm run test -- task-parser\",\n  \"description\": \"Scoped parser Vitest command (blocked until dependencies are installed)\",\n  \"cwd\": \"/Users/gannonhall/intent/workspaces/following-build-2/kata-cloud\",\n  \"display\": {\n    \"showCommandPrefix\": \"$\"\n  }\n}\n```\n\n```ws-block:cli\n{\n  \"id\": \"848bc913-aa0a-4266-a1dd-13b8ba9b3f48\",\n  \"version\": 1,\n  \"type\": \"cli\",\n  \"createdAt\": \"2026-02-16T15:21:16.501Z\",\n  \"createdBy\": \"agent\",\n  \"command\": \"node --input-type=module -e \\\"import('./packages/task-parser/src/index.js').then((m)=>console.log('exports',Object.keys(m).sort().join(',')))\\\"\",\n  \"description\": \"Node runtime import smoke for parser module boundary\",\n  \"cwd\": \"/Users/gannonhall/intent/workspaces/following-build-2/kata-cloud\",\n  \"display\": {\n    \"showCommandPrefix\": \"$\"\n  }\n}\n```\n\n```ws-block:cli\n{\n  \"id\": \"0c90b584-a28e-47c1-8a5d-609b511c0c4d\",\n  \"version\": 1,\n  \"type\": \"cli\",\n  \"createdAt\": \"2026-02-16T15:21:16.547Z\",\n  \"createdBy\": \"agent\",\n  \"command\": \"node --input-type=module <<'EOF'\\nimport assert from 'node:assert/strict';\\nimport { syncTaskBlocks } from './packages/task-parser/src/index.js';\\n\\nconst tasksById = new Map();\\nconst taskIdByTitle = new Map();\\nlet sequence = 0;\\nconst normalize = (title) => title.trim().toLowerCase().replace(/\\\\s+/g, ' ');\\n\\nconst store = {\\n  findById(id) {\\n    return id ? tasksById.get(id) ?? null : null;\\n  },\\n  findByTitle(title) {\\n    const id = taskIdByTitle.get(normalize(title));\\n    return id ? tasksById.get(id) ?? null : null;\\n  },\\n  upsert(input) {\\n    const normalized = normalize(input.title);\\n    const id = input.id ?? taskIdByTitle.get(normalized) ?? `task-${++sequence}`;\\n    const next = { id, title: input.title, description: input.description ?? '', status: input.status ?? 'not_started' };\\n    tasksById.set(id, next);\\n    taskIdByTitle.set(normalized, id);\\n    return next;\\n  }\\n};\\n\\nconst spec = [\\n  '## Tasks',\\n  '@@@task',\\n  '# Duplicate title',\\n  'First body.',\\n  '@@@',\\n  '',\\n  '@@@task',\\n  '# Duplicate title',\\n  'Second body.',\\n  '@@@'\\n].join('\\\\n');\\n\\nconst result = syncTaskBlocks(spec, store);\\nassert.equal(result.taskIds.length, 2);\\nassert.equal(new Set(result.taskIds).size, 2);\\nassert.equal((result.specMarkdown.match(/intent:\\\\/\\\\/local\\\\/task\\\\//g) || []).length, 2);\\nconsole.log('duplicate-title smoke: PASS');\\nEOF\",\n  \"description\": \"Duplicate-title one-block-one-task smoke against a title-collapsing store\",\n  \"cwd\": \"/Users/gannonhall/intent/workspaces/following-build-2/kata-cloud\",\n  \"display\": {\n    \"showCommandPrefix\": \"$\"\n  }\n}\n```\n","title":"Enforce one-block-one-task for duplicate titles and normalize parser module boundary"}
{"type":"diff","v":2,"date":"2026-02-16T15:33:39.661Z","author":{"id":"user","name":"User","type":"user"},"diff":"@@ -92 +92 @@\n-"}
