---
id: 5eda575f-6be5-4c03-a27f-ae1ca6b2b797
title: Implement spec-draft synthesis from orchestrator runs
parent: spec
created: "2026-02-16T23:23:02.527Z"
task:
  status: complete
  peerOrder: 200
  startedAt: "2026-02-16T23:39:52.030Z"
  assignedAgentIds: [agent-2fc196b0-b029-4789-9f31-c165b6baf65c, agent-29156573-224d-4f99-9d8b-ea7183346131]
  completedAt: "2026-02-16T23:43:41.090Z"
---

# Implement spec-draft synthesis from orchestrator runs

Generate and persist a draft spec payload from orchestrator context so users can review/edit proposed plan content.

## Scope
In scope: deterministic spec-draft generation path, write/update integration with spec note flow, and UI visibility of latest draft result.
Out of scope: advanced prompt optimization and multi-model routing.

## Inputs
- [Spec](intent://local/note/spec)
- [Build spec note panel with autosave and comment threads](intent://local/task/43a5ba09-1e2b-43db-b354-4d90a46f1cdf)
- [Ship orchestrator planning loop and specialist task delegation](intent://local/task/55f46e5e-e243-4efc-971b-fd5cd1504a85)

## Definition of Done
- Successful runs produce a structured spec-draft artifact tied to run id.
- User can apply/update draft content through existing spec note pathway.
- Failure states are surfaced without corrupting existing spec content.

## Verification
- `pnpm run desktop:typecheck`
- `pnpm test -- notes`
- `pnpm test -- orchestrator`

## Implementation Update (Turn 1)

### Summary
Implemented deterministic spec-draft synthesis in the orchestrator run-completion path, persisted the draft artifact on the run record, and wired draft apply through the existing spec note save path with explicit success/failure surfacing tied to run id.

### Acceptance Criteria
- ✅ Completed orchestrator runs produce a structured draft artifact tied to run id.
- ✅ User can apply/update draft content through existing spec note pathway.
- ✅ Failure states are surfaced and do not corrupt current spec content.

### Changes
- `src/shared/state.ts`
  - Added `OrchestratorSpecDraft` and run-level draft fields (`draft`, `draftAppliedAt`, `draftApplyError`).
  - Extended run normalization/validation to persist only valid draft artifacts.
- `src/main.tsx`
  - Added deterministic `createSpecDraft` synthesis and attached draft to completed runs.
  - Added draft-apply result persistence (`applied`/`failed`) on run records.
  - Passed latest run draft artifact into `SpecNotePanel` and surfaced draft/apply status in Orchestrator UI bound to run id.
- `src/features/spec-panel/spec-note-panel.tsx`
  - Added draft card for incoming orchestrator artifact and `Apply Draft to Spec` action.
  - Reused existing `saveSpecNote(...)` path to apply draft content.
  - Added explicit failure message path when draft apply write fails.
- `src/features/spec-panel/spec-note-panel.test.tsx`
  - Added tests for successful draft apply and failed draft apply preserving current content.
- `src/shared/orchestrator-state.test.ts`
  - Extended normalization coverage for valid draft retention and invalid draft rejection.

### Verification
- `pnpm run desktop:typecheck` -> PASS
  - Evidence: `tsc --noEmit -p tsconfig.main.json && tsc --noEmit -p tsconfig.renderer.json` exited 0.
- `pnpm test -- notes` -> PASS
  - Evidence: `Test Files 15 passed`, `Tests 44 passed`.
- `pnpm test -- orchestrator` -> PASS
  - Evidence: `Test Files 15 passed`, `Tests 44 passed`.

### DoD Claim Mapping
1. **Structured draft artifact tied to run id**: satisfied via persisted `draft` object on `OrchestratorRunRecord` with `runId` and deterministic generated content on completed runs.
2. **Apply/update through existing spec pathway**: satisfied via `SpecNotePanel` draft apply using `saveSpecNote(...)` (existing write/update path).
3. **Failure surfaced without corrupting current spec**: satisfied via explicit draft-apply failure status in panel + run record, with spec content unchanged when storage write fails.

### Residual Risks
- Draft template is intentionally deterministic/minimal; quality/content richness is limited by scope.
- Draft-apply race behavior relies on current in-memory `state` snapshot in `onSpecDraftApplied`; concurrent run updates in future may need a reducer-style state merge.

## Verification Update (Turn 2 - Verifier)

### Scope
Wave 2.1 Task 2 only: `Implement spec-draft synthesis from orchestrator runs`.

### Severity-ranked findings
- P0: None.
- P1: None.
- P2: None blocking DoD. Existing deprecation warning in tests (`ReactDOMTestUtils.act`) observed, but unrelated to this task's acceptance criteria.

### DoD verification
1. **Completed runs produce structured draft artifact tied to run id** — **VERIFIED**
   - Evidence: `createSpecDraft` binds `runId` onto draft payload and completion path stores `draft` on ended run record in `src/main.tsx:104`, `src/main.tsx:468`, `src/main.tsx:474`.
   - Evidence: Run/draft schema persisted in shared state model via `OrchestratorSpecDraft` and `OrchestratorRunRecord.draft` in `src/shared/state.ts:11`, `src/shared/state.ts:37`, `src/shared/state.ts:48`.
   - Evidence: normalization test keeps valid draft and lifecycle timeline in `src/shared/orchestrator-state.test.ts:5`.

2. **User can apply/update draft via existing spec note pathway** — **VERIFIED**
   - Evidence: Spec panel applies draft by calling existing `saveSpecNote(...)` persistence path in `src/features/spec-panel/spec-note-panel.tsx:121`, `src/features/spec-panel/spec-note-panel.tsx:134`.
   - Evidence: orchestrator draft is passed to same Spec panel surface from app shell in `src/main.tsx:1079`.
   - Evidence: apply success test asserts persisted spec content and callback status in `src/features/spec-panel/spec-note-panel.test.tsx:119`.

3. **Failure surfaced and does not corrupt existing spec content** — **VERIFIED**
   - Evidence: draft apply failure path sets explicit UI failure status and propagates failed result callback in `src/features/spec-panel/spec-note-panel.tsx:139`.
   - Evidence: orchestrator view renders run error and draft-apply error messages tied to latest run in `src/main.tsx:992`, `src/main.tsx:995`.
   - Evidence: failure test verifies error surfaced and editor content remains unchanged after failed apply in `src/features/spec-panel/spec-note-panel.test.tsx:143`.

### Out-of-scope check
No provider runtime, multi-model routing, PR workflow, browser preview, or context-adapter implementation was introduced in task-scoped changes (`src/main.tsx`, `src/shared/state.ts`, `src/features/spec-panel/*`, `src/shared/orchestrator-state.test.ts`).

### Commands run
- `pnpm run desktop:typecheck` → PASS
- `pnpm test -- notes` → PASS
- `pnpm test -- orchestrator` → PASS

### GO/NO-GO
**GO** for Wave 2.1 Task 2.