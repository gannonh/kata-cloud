---
id: b5b5509f-53b0-46b8-93aa-53e65fd88711
title: Add coverage targets and enforcement
parent: spec
created: "2026-02-16T18:29:23.762Z"
task:
  status: complete
  peerOrder: 200
  startedAt: "2026-02-16T18:38:35.267Z"
  assignedAgentIds: [agent-89db448c-678c-4a89-8583-22efb6adfbe8, agent-f6b5791b-9830-47a1-b097-b7b2942de232]
  completedAt: "2026-02-16T19:41:40.289Z"
---

# Add coverage targets and enforcement

Define and enforce explicit test coverage thresholds for the current test suite.

## Scope
In scope: Vitest coverage configuration, threshold policy, and coverage script(s).
Out of scope: large test rewrites purely to raise coverage in this wave.

## Inputs
[Spec](intent://local/note/spec)

## Definition of Done
- Coverage reporting is enabled in test configuration.
- Minimum thresholds are defined and enforced in local/CI runs.
- A dedicated coverage command is documented and runnable.

## Verification
- `pnpm install`
- `pnpm run test -- --coverage`

## Summary (Turn 1)
Implement Vitest coverage collection + threshold enforcement only, targeting policy `80/80/80/70` (statements/functions/lines/branches). Keep scope to config + verification evidence using existing `pnpm run test -- --coverage` path.

## Acceptance Criteria
- [ ] Coverage config exists in Vitest and is runnable with current test command path.
- [ ] Thresholds are enforced at `statements: 80`, `functions: 80`, `lines: 80`, `branches: 70`.
- [ ] Verification evidence for `pnpm run test -- --coverage` is recorded in this note.

## Subtasks
- None.

## References
- `vitest.config.ts`

## Learnings
- None yet.

## Changes
- Pending implementation.

## Summary (Turn 2)
Implemented Vitest coverage enforcement with policy thresholds (`80/80/80/70`) and enabled runnable coverage collection using the minimally equivalent command path (`pnpm run test --coverage`) required by current script wiring.

## Acceptance Criteria (Final)
- ✅ Coverage config exists in Vitest and is runnable (`vitest.config.ts` with `coverage` block).
- ✅ Thresholds are enforced at `statements: 80`, `functions: 80`, `lines: 80`, `branches: 70`.
- ✅ Verification evidence is recorded for task commands, including the required command-path caveat.

## Learnings
- `pnpm run test -- --coverage` currently executes as `vitest run -- --coverage` and does **not** trigger coverage mode in this setup.
- `pnpm run test --coverage` is the minimally equivalent runnable path for enforcement without package-script churn.

## Changes
- `vitest.config.ts`: added `test.coverage` config with `provider: "v8"`, reporters (`text`, `json-summary`), and thresholds (`80/70/80/80` for statements/branches/functions/lines).
- `package.json`: added dev dependency `@vitest/coverage-v8` pinned to `^3.2.4` (matching Vitest v3).
- `pnpm-lock.yaml`: lockfile updates for `@vitest/coverage-v8` and its resolved dependency graph.

## Verification Evidence
1. `pnpm install`
- Result: ✅ pass (`Lockfile is up to date`, `Already up to date`).

2. `pnpm run test -- --coverage`
- Result: ✅ command succeeds, but coverage is **not** activated in this setup (`vitest run -- --coverage`; no coverage report/threshold enforcement emitted).

3. `pnpm run test --coverage` (minimally equivalent runnable command)
- Result: ❌ fails on enforced thresholds, proving enforcement is active.
- Reported failures:
  - `Coverage for lines (47.53%) does not meet global threshold (80%)`
  - `Coverage for functions (78.83%) does not meet global threshold (80%)`
  - `Coverage for statements (47.53%) does not meet global threshold (80%)`

## Minimal Rollout Recommendation
Keep thresholds as configured (do not lower policy). In CI/local gate execution, run `pnpm run test --coverage` (or add a dedicated `test:coverage` script in a separate task) so enforcement is actually applied. Current codebase remains below policy and should stay failing until targeted test additions raise statement/line/function coverage.

```ws-block:cli
{
  "id": "fff0f3c9-241a-4858-8e7f-0cf51a7f9ab2",
  "version": 1,
  "type": "cli",
  "createdAt": "2026-02-16T18:58:40.063Z",
  "createdBy": "agent",
  "command": "pnpm install",
  "description": "Install dependencies and validate lockfile state",
  "cwd": "./",
  "display": {
    "showCommandPrefix": "$"
  }
}
```

```ws-block:cli
{
  "id": "31863dc0-871e-451a-8c82-946def13ad84",
  "version": 1,
  "type": "cli",
  "createdAt": "2026-02-16T18:58:40.076Z",
  "createdBy": "agent",
  "command": "pnpm run test -- --coverage",
  "description": "Requested verification path from task note (shows command-path caveat)",
  "cwd": "./",
  "display": {
    "showCommandPrefix": "$"
  }
}
```

```ws-block:cli
{
  "id": "b1ea761d-8919-4312-9104-58a36445b967",
  "version": 1,
  "type": "cli",
  "createdAt": "2026-02-16T18:58:40.090Z",
  "createdBy": "agent",
  "command": "pnpm run test --coverage",
  "description": "Minimally equivalent Vitest coverage enforcement command",
  "cwd": "./",
  "display": {
    "showCommandPrefix": "$"
  }
}
```