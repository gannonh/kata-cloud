---
id: 2c119395-f7be-4595-8e2a-98cb9d976e62
title: Integrate task-block conversion into spec save/autosave
parent: spec
created: "2026-02-16T15:08:31.891Z"
task:
  status: complete
  peerOrder: 100
  assignedAgentIds: [agent-5fe205f0-272b-420b-b3ca-da8dfac44cfe]
  startedAt: "2026-02-16T15:15:41.103Z"
  completedAt: "2026-02-16T15:25:00.646Z"
---

# Integrate task-block conversion into spec save/autosave

Ensure `

## Summary (Turn 1)
Mapped current spec save/autosave flow to `saveSpecNote` in `src/features/spec-panel/store.ts`. Existing task-block parser/sync exists under `packages/task-parser` but is not wired into this save path yet.

## Acceptance Criteria
- [ ] Saving spec content via `saveSpecNote` converts `@@@task` blocks into `intent://local/task/...` links.
- [ ] Autosave flow in `SpecNotePanel` uses the same conversion behavior without extra call-site changes.
- [ ] Converted task links remain stable across subsequent saves for unchanged tasks.
- [ ] In-scope tests cover conversion on save/autosave path.

## References
- `src/features/spec-panel/store.ts`
- `src/features/spec-panel/spec-note-panel.tsx`
- `src/features/spec-panel/spec-note-panel.test.tsx`
- `packages/task-parser/src/task-sync.js`

## Learnings
- Task note body appears truncated in existing content; appending structured sections avoids losing tracking context.

## Changes
- None yet (discovery only).

```ws-block:cli
{
  "id": "020eab2a-3fdf-4db7-b7d5-7c4fe456fe80",
  "version": 1,
  "type": "cli",
  "createdAt": "2026-02-16T15:24:39.240Z",
  "createdBy": "agent",
  "command": "pnpm run test -- notes",
  "description": "Run notes/spec-panel tests for task-block conversion wiring",
  "cwd": "/Users/gannonhall/intent/workspaces/following-build-2/kata-cloud",
  "display": {
    "showCommandPrefix": "$"
  }
}
```

```ws-block:cli
{
  "id": "83b342ae-5293-40b5-bd60-816f6a168c72",
  "version": 1,
  "type": "cli",
  "createdAt": "2026-02-16T15:24:44.077Z",
  "createdBy": "agent",
  "command": "pnpm install",
  "description": "Install dependencies required to run Vitest locally",
  "cwd": "/Users/gannonhall/intent/workspaces/following-build-2/kata-cloud",
  "display": {
    "showCommandPrefix": "$"
  }
}
```

## Summary (Turn 2)
Implemented scoped save-path wiring so `saveSpecNote` now converts `@@@task` blocks into task links during both autosave and explicit save calls (all save paths call this function). Conversion now persists task metadata so repeated saves of stale editor content reuse stable task IDs.

## Acceptance Criteria Status
- ✅ Saving spec content via `saveSpecNote` converts `@@@task` blocks into `intent://local/task/...` links.
- ✅ Autosave/manual save call paths are covered because both route through `saveSpecNote`.
- ✅ Task IDs remain stable across repeated saves of identical task-block content (seeded from persisted task records).
- ✅ Added in-scope regression tests under `src/notes` for conversion + ID stability.

## Changes
- `src/features/spec-panel/store.ts`: integrated task-block parse/sync into `saveSpecNote`; added persisted `tasks` support, task validation, and link/status synchronization.
- `src/features/spec-panel/types.ts`: added `SpecTaskRecord`/`SpecTaskStatus`; extended `SpecNoteDocument` with optional `tasks`.
- `src/features/spec-panel/index.ts`: exported new task-related types.
- `src/notes/types.ts`: re-exported new task-related types.
- `src/notes/store.test.ts`: added regression tests for save conversion and stable ID reuse.
- `src/notes/spec-note-panel.test.tsx`: updated autosave test to assert task-block conversion in persisted output.

## Verification
- `pnpm run test -- notes` ❌ failed: `sh: vitest: command not found` (local `node_modules` missing).
- `pnpm install` ❌ failed: `getaddrinfo ENOTFOUND registry.npmjs.org` (network/DNS unavailable in this environment).
- Blocker: cannot execute Vitest verification until dependency install is possible in a network-enabled environment.

## Learnings
- Because the live editor state may still contain `@@@task` content after a save, seeding conversion from persisted note tasks avoids ID churn on subsequent autosave/unmount saves without widening scope into UI state refactors.