---
id: dfb65dc8-1eb9-47f1-b95f-e22c99005ddb
title: Implement real model provider runtime and authentication
parent: spec
created: "2026-02-16T14:06:28.407Z"
task:
  status: not_started
  peerOrder: 100
---

# Implement real model provider runtime and authentication

Add production-path model integration for Anthropic and OpenAI with both API-key and token-based authenticated sessions.

## Scope
Implement provider adapters and credential/session detection for Anthropic and OpenAI. Support API key entry/storage plus token-authenticated state detection where supported by local provider tooling/session context. Include provider selection, model listing, and request execution for orchestrator/specialists.

## Inputs
`docs/kata-cloud-ovweview.md`
`docs/kata-context.md`
`[Spec](intent://local/note/spec)`

## Definition of Done
- Anthropic and OpenAI can both execute real completion/tool requests from the app.
- User can configure API keys and use token-authenticated sessions when available.
- Auth mode and provider health are visible in settings/status UI.
- Clear fallback/error handling exists for expired or missing auth.

## Verification
- `pnpm run test -- providers`
- Manual: execute prompts against Anthropic and OpenAI using API key mode and token-authenticated mode
## Execution Plan (2026-02-17)

### Architecture touchpoints
1. `/Users/gannonhall/.codex/worktrees/23f6/kata-cloud/src/shared/shell-api.ts`
- Add provider-runtime IPC contracts and types (`listProviderAuthStatus`, `saveProviderCredential`, `clearProviderCredential`, `runProviderCompletion`, `listProviderModels`).
- Keep request/response payloads typed and explicit (including auth mode, provider, model, and typed error codes).

2. `/Users/gannonhall/.codex/worktrees/23f6/kata-cloud/src/preload/index.ts`
- Extend `kataShell` bridge with provider/auth methods.
- Preserve current security boundary (`contextIsolation`, no direct renderer access to secrets).

3. `/Users/gannonhall/.codex/worktrees/23f6/kata-cloud/src/main/index.ts`
- Instantiate a provider runtime/auth service in main process and register IPC handlers.
- Keep secret handling and provider SDK calls main-process-only.
- Reuse current typed-error pattern used by `PullRequestWorkflowService` for actionable remediation strings.

4. `/Users/gannonhall/.codex/worktrees/23f6/kata-cloud/src/main.tsx`
- Add provider/auth settings UI (provider selection, auth mode, model, health/status).
- Wire orchestrator execution path from deterministic local simulation to real provider call path behind a feature flag.
- Keep existing runtime fallback behavior in web-only mode (`window.kataShell` unavailable) with clear user messaging.

5. Provider/context modules (new domain)
- Add `src/providers/` domain (recommended structure):
  - `types.ts`, `validation.ts`, `errors.ts`
  - `provider-runtime-service.ts`
  - `provider-auth-service.ts`
  - `providers/anthropic-provider.ts`
  - `providers/openai-provider.ts`
  - `session-detectors/anthropic-session-detector.ts`
  - `session-detectors/openai-session-detector.ts`
- Context dependency touchpoint:
  - If/when context adapter lands (`src/context/**`), pass retrieved snippets into provider request builder.
  - If context adapter is absent on `origin/main`, degrade to prompt-only execution and surface `context unavailable` as non-blocking metadata.

### Auth matrix (provider x mode)
| Provider | Auth mode | Success path | Fallback behavior | Error behavior |
| --- | --- | --- | --- | --- |
| Anthropic | API key | Use stored key via main-process credential store and call Anthropic adapter directly. | If key missing and token session is healthy, optionally fall back to token session when mode fallback is enabled. | Return typed `AUTH_MISSING`/`AUTH_INVALID`; renderer shows remediation and run is marked failed. |
| Anthropic | Token-auth session | Detect local Anthropic session state via detector; execute without exposing token to renderer. | If session missing/expired and API key exists, fall back to API key when mode fallback is enabled. | Return typed `AUTH_SESSION_MISSING`/`AUTH_SESSION_EXPIRED`; suggest reconnect flow. |
| OpenAI | API key | Use stored key via main-process credential store and call OpenAI adapter directly. | If key missing and token session is healthy, optionally fall back to token session when mode fallback is enabled. | Return typed `AUTH_MISSING`/`AUTH_INVALID`; renderer shows remediation and run is marked failed. |
| OpenAI | Token-auth session | Detect local OpenAI/Codex session state via detector; execute without exposing token to renderer. | If session missing/expired and API key exists, fall back to API key when mode fallback is enabled. | Return typed `AUTH_SESSION_MISSING`/`AUTH_SESSION_EXPIRED`; suggest reconnect flow. |

Fallback policy rules:
1. Same-provider auth-mode fallback is attempted first when enabled.
2. Cross-provider fallback is attempted second (based on routing profile) only for retry-safe errors (`AUTH_*`, transient `RATE_LIMITED`, transient network failures).
3. Hard errors (`MODEL_NOT_FOUND`, validation failures, policy-denied) do not auto-fallback.

### Recommended PR sequence
1. PR-1: Contracts and state scaffolding
- Scope: shell IPC contracts/types, provider config/auth status types, feature flag wiring, baseline tests for type guards/state normalization.
- Merge gate: no behavior change to current orchestrator runtime.

2. PR-2: Main-process provider/auth service skeleton
- Scope: add `src/providers/` domain with typed errors, auth-status resolution, secure credential storage abstraction, IPC wiring in `src/main/index.ts` and preload bridge.
- Merge gate: renderer can query provider status; no live model calls yet.

3. PR-3: Real provider runtime (API-key mode first)
- Scope: Anthropic/OpenAI adapters for API-key execution path, model listing, orchestrator invocation integration, run result persistence.
- Merge gate: both providers run successfully via API key mode with deterministic test doubles.

4. PR-4: Token-auth session mode + fallback matrix
- Scope: token-session detectors for Anthropic/OpenAI, fallback sequencing engine, typed auth/rate-limit/transient error mapping.
- Merge gate: matrix coverage for all 4 provider/mode combinations and explicit failure states.

5. PR-5: Renderer UX hardening + docs/UAT polish
- Scope: status UX improvements in `src/main.tsx`, remediation messaging, manual UAT scripts/checklist updates, final regression suite updates.
- Merge gate: full verification command set passes; manual matrix checklist passes.

### File ownership map
| Area | Files | Ownership intent |
| --- | --- | --- |
| Renderer runtime/auth UX | `/Users/gannonhall/.codex/worktrees/23f6/kata-cloud/src/main.tsx` | Provider selection, auth mode controls, status messaging, orchestrator run trigger integration. |
| IPC contract | `/Users/gannonhall/.codex/worktrees/23f6/kata-cloud/src/shared/shell-api.ts` | Canonical request/response contracts and channel naming for provider runtime/auth. |
| Renderer bridge | `/Users/gannonhall/.codex/worktrees/23f6/kata-cloud/src/preload/index.ts` | Safe `kataShell` exposure for new provider methods. |
| Main process wiring | `/Users/gannonhall/.codex/worktrees/23f6/kata-cloud/src/main/index.ts` | Handler registration, service lifecycle, error translation boundaries. |
| Provider runtime domain | `/Users/gannonhall/.codex/worktrees/23f6/kata-cloud/src/providers/**` | Auth resolution, credential access, provider adapters, fallback routing, request execution. |
| Shared state model | `/Users/gannonhall/.codex/worktrees/23f6/kata-cloud/src/shared/state.ts` and `/Users/gannonhall/.codex/worktrees/23f6/kata-cloud/src/shared/state.test.ts` | Persisted provider preferences, selected mode/model, and health snapshots. |
| Context integration seam | `/Users/gannonhall/.codex/worktrees/23f6/kata-cloud/src/context/**` (when available) | Context snippets retrieval and provider request enrichment contract. |
| Tests | `/Users/gannonhall/.codex/worktrees/23f6/kata-cloud/src/providers/**/*.test.ts`, `/Users/gannonhall/.codex/worktrees/23f6/kata-cloud/src/providers/**/*.node.test.ts`, targeted updates in shared/main tests | Matrix coverage, fallback behavior, IPC contract correctness, regression checks. |

### Verification/UAT gates
Automated command list (expected in each PR and final gate):
1. `pnpm run lint`
2. `pnpm test -- providers`
3. `pnpm test -- orchestrator`
4. `pnpm test -- state`
5. `pnpm run desktop:typecheck`
6. `pnpm test`

Manual UAT checklist:
1. Anthropic API key mode: connect, run orchestrator prompt, verify completed run and response provenance.
2. OpenAI API key mode: connect, run orchestrator prompt, verify completed run and response provenance.
3. Anthropic token-session mode: with active session, run prompt successfully without API key entry.
4. OpenAI token-session mode: with active session, run prompt successfully without API key entry.
5. Token session expired/missing for each provider: verify actionable remediation and failed run status (not silent success).
6. Mode fallback path: token-session unavailable but API key exists should recover when fallback is enabled.
7. Cross-provider fallback path: simulate primary transient failure, verify secondary-provider retry behavior and clear audit trail.
8. Web-only/runtime-unavailable path: verify provider actions are disabled and show runtime-required message.
9. Restart persistence: provider preferences and non-secret status persist; secrets are not rendered or logged.

### Risks, dependencies, mitigations
1. Dependency: context adapter modules are not present on current `origin/main`.
- Mitigation: implement provider runtime with optional context seam; gate rich-context wiring behind availability check/feature flag.

2. Risk: secure credential storage choice can block cross-platform builds.
- Mitigation: define credential-store abstraction in PR-2; start with a tested desktop-safe backend and fallback strategy before UI wiring.

3. Risk: token-session detection mechanisms vary by provider/tooling and may be brittle.
- Mitigation: detector interface with explicit states (`available`, `missing`, `expired`, `unknown`) and provider-specific adapters behind tests.

4. Risk: provider API/rate-limit behavior introduces non-deterministic failures.
- Mitigation: typed transient vs hard error classification plus bounded retry/fallback policy and deterministic mocked tests.

5. Risk: regressions to existing deterministic orchestrator flow.
- Mitigation: keep provider runtime behind feature flag until PR-4 matrix is green; retain current simulated path as rollback option during rollout.

### GO conditions to start implementation
1. Confirm implementation base is still fresh `origin/main` at kickoff (no carry-over feature branch state).
2. Confirm whether context adapter integration is required now or deferred behind optional seam.
3. Approve credential storage strategy and secret-handling constraints (no secret in renderer state/logs/persisted JSON).
4. Approve token-session detector sources for Anthropic and OpenAI.
5. Approve default routing/fallback policy (same-provider mode fallback first, cross-provider fallback second).
6. Confirm availability of test credentials/sessions for all four auth-matrix paths for manual UAT.
