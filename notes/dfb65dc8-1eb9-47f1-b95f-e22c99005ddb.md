---
id: dfb65dc8-1eb9-47f1-b95f-e22c99005ddb
title: Implement real model provider runtime and authentication
parent: spec
created: "2026-02-16T14:06:28.407Z"
task:
  status: not_started
  peerOrder: 100
---

# Implement real model provider runtime and authentication

Add production-path model integration for Anthropic and OpenAI with both API-key and token-based authenticated sessions.

## Scope
Implement provider adapters and credential/session detection for Anthropic and OpenAI. Support API key entry/storage plus token-authenticated state detection where supported by local provider tooling/session context. Include provider selection, model listing, and request execution for orchestrator/specialists.

## Inputs
`docs/kata-cloud-ovweview.md`
`docs/kata-context.md`
`[Spec](intent://local/note/spec)`

## Definition of Done
- Anthropic and OpenAI can both execute real completion/tool requests from the app.
- User can configure API keys and use token-authenticated sessions when available.
- Auth mode and provider health are visible in settings/status UI.
- Clear fallback/error handling exists for expired or missing auth.

## Verification
- `pnpm run test -- providers`
- Manual: execute prompts against Anthropic and OpenAI using API key mode and token-authenticated mode

## Execution Plan (2026-02-17)

### 1. Recommended PR Slice Sequence (Small, Mergeable)
1. `PR-A`: Shared contracts + state scaffolding only.
   - Add provider/auth runtime types, IPC contract additions, and state fields for provider health/auth mode display.
   - No live provider calls yet.
2. `PR-B`: Main-process provider runtime framework.
   - Add runtime orchestration shell, provider registry, and structured error model in main process.
   - Add tests with mocked adapters.
3. `PR-C`: Anthropic API key execution path.
   - Implement Anthropic adapter for model listing and prompt execution using API key mode.
   - Wire health reporting and actionable error surfaces.
4. `PR-D`: OpenAI API key execution path.
   - Implement OpenAI adapter for model listing and prompt execution using API key mode.
   - Match Anthropic behavior contract.
5. `PR-E`: Token-auth session mode integration.
   - Add session detection + execution paths for Anthropic/OpenAI token-auth mode.
   - Enforce deterministic fallback from token mode to API key mode when allowed.
6. `PR-F`: Renderer settings/status UX + execution wiring.
   - Add provider selection, auth mode visibility, and runtime status/error affordances.
7. `PR-G`: Hardening pass.
   - Retry/backoff policy checks, telemetry/logging polish, regression tests, and docs cleanup.

### 2. Auth Matrix (Provider x Mode + Fallback/Error)
| Provider | Mode | Primary Auth Source | Fallback Behavior | Error Behavior |
| --- | --- | --- | --- | --- |
| Anthropic | API key mode | Stored user API key | No fallback if key missing (provider unavailable) | Missing/invalid key => block Anthropic requests with actionable message, keep app usable for other providers |
| Anthropic | Token-auth session mode | Local authenticated Anthropic session context | If session missing/expired, fall back to Anthropic API key when present; else unavailable | Session detect/refresh failure => degrade to fallback path and emit non-fatal provider error |
| OpenAI | API key mode | Stored user API key | No fallback if key missing (provider unavailable) | Missing/invalid key => block OpenAI requests with actionable message, keep app usable for other providers |
| OpenAI | Token-auth session mode | Local authenticated OpenAI session context | If session missing/expired, fall back to OpenAI API key when present; else unavailable | Session detect/refresh failure => degrade to fallback path and emit non-fatal provider error |

### 3. File Ownership Map
- `src/main/index.ts`
  - IPC handler registration and routing for provider runtime operations.
- `src/preload/index.ts`
  - `kataShell` bridge methods for provider/auth status, model listing, and request execution.
- `src/shared/shell-api.ts`
  - IPC channel names and typed request/response contracts.
- `src/shared/state.ts`
  - App-state shape + normalization for provider auth mode/health visibility.
- `src/main.tsx`
  - Renderer orchestration/settings integration, provider selection, and user-facing error handling.
- `src/main/provider-runtime/*` (new)
  - Main-process provider runtime coordinator, auth-mode resolver, fallback policy, provider registry.
- `src/main/providers/anthropic/*` (new)
  - Anthropic adapter implementation (API key + token session mode).
- `src/main/providers/openai/*` (new)
  - OpenAI adapter implementation (API key + token session mode).

### 4. Verification Plan
Automated commands:
- `pnpm run lint`
- `pnpm run desktop:typecheck`
- `pnpm test`
- `pnpm test -- providers`

Manual UAT checklist:
1. Start desktop app and verify provider settings view loads with no auth configured.
2. Configure Anthropic API key and confirm model list + prompt execution succeed.
3. Configure OpenAI API key and confirm model list + prompt execution succeed.
4. Enable token-auth session mode for Anthropic and confirm active-session execution path is used.
5. Enable token-auth session mode for OpenAI and confirm active-session execution path is used.
6. Expire/remove token sessions and verify deterministic fallback to API key when available.
7. Remove API keys and confirm provider-specific actionable errors without app-wide failure.
8. Confirm auth mode + provider health indicators stay in sync after state refresh/app restart.

### 5. Explicit GO Conditions (Implementation Start Gates)
- Gate 1: Context verifier closeout status is moved from NO-GO to GO by a merged note update (PR #28 follow-up).
- Gate 2: Browser gate sequence/rebase-prep dependencies are confirmed clear and current against merged PR #27 guidance.
- Gate 3: `origin/main` contains both gate outcomes, and this task branch is rebased/created from that baseline.
- Gate 4: Provider runtime contract review is approved (IPC contracts, state fields, fallback semantics) before adapter coding.
- Gate 5: Test harness readiness confirmed for provider mocks and token-session simulation.

No provider runtime implementation work should start until all gates above are satisfied.

### 6. Risks and Mitigations
- Risk: Token-session detection differs across developer/user environments.
  - Mitigation: Isolate detection behind provider-specific resolvers with explicit timeout/error classification and test doubles.
- Risk: Auth fallback order becomes inconsistent between providers.
  - Mitigation: Centralize fallback policy in shared runtime coordinator and enforce via contract tests.
- Risk: Renderer state drifts from main-process provider status.
  - Mitigation: Keep provider status canonical in main process and broadcast typed state updates through one IPC path.
- Risk: API key and token modes surface ambiguous errors.
  - Mitigation: Standardize error taxonomy (`missing_auth`, `invalid_auth`, `session_expired`, `provider_unavailable`) with mapped UX copy.
- Risk: Large integration PRs regress unrelated orchestrator paths.
  - Mitigation: Enforce the PR slicing above and require green tests/typecheck per slice before merge.
