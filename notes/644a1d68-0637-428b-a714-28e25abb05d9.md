---
id: 644a1d68-0637-428b-a714-28e25abb05d9
title: Fix deterministic failure-path trigger and error surfacing
parent: spec
created: "2026-02-17T00:18:35.295Z"
task:
  status: not_started
  peerOrder: 100
  assignedAgentIds: [agent-e68d113d-99f5-49fd-b99d-1bc53f8a8976]
  startedAt: "2026-02-17T00:31:01.520Z"
---

# Fix deterministic failure-path trigger and error surfacing

Make orchestrator runs fail deterministically when the configured failure trigger is present, and surface actionable failure information in the UI.

## Scope
In scope: failure-trigger evaluation in orchestrator run execution, failed lifecycle/terminal state handling, and visible failure messaging in orchestrator status.
Out of scope: provider runtime/auth, GitHub PR workflow, browser preview, context adapter work.

## Inputs
- [Spec](intent://local/note/spec)
- [Ship orchestrator planning loop and specialist task delegation](intent://local/task/55f46e5e-e243-4efc-971b-fd5cd1504a85)

## Definition of Done
- A prompt containing the configured failure trigger results in run lifecycle `queued -> running -> failed`.
- Failure state includes actionable error text in orchestrator status UI.
- Failure path does not corrupt existing spec content.

## Verification
- `pnpm run desktop:typecheck`
- `pnpm test -- orchestrator`
- Manual: run prompt containing trigger keyword and confirm failed terminal state + error copy

## Summary (Turn 2)
Implemented deterministic failure trigger detection for the `fail` keyword (case-insensitive, word-boundary), wired it into orchestrator run execution, and surfaced actionable failure guidance in the run error message. Added focused unit tests and validated orchestrator suite + desktop typecheck.

## Acceptance Criteria
- [x] Prompt containing configured deterministic trigger forces terminal run status to `failed` with lifecycle `queued -> running -> failed`.
- [x] Failure details are surfaced in orchestrator status UI with actionable message text.
- [x] Failure path leaves spec content unchanged.
- [x] `pnpm test -- orchestrator` and `pnpm run desktop:typecheck` pass.

## Subtasks
- [x] None delegated.

## References
- `spec` Wave 2.1 UAT case 4 failure evidence.
- `src/main.tsx`
- `src/shared/orchestrator-failure.ts`
- `src/shared/orchestrator-failure.test.ts`

## Learnings
- Root cause: deterministic trigger contract drifted (`run-fail` in code vs `fail` used in UAT). Centralizing trigger detection in a shared utility makes behavior explicit and testable.

## Changes
- `src/main.tsx`: replaced inline failure-trigger logic with shared `resolveRunFailure` import.
- `src/shared/orchestrator-failure.ts`: added deterministic trigger detection and actionable failure-message resolver.
- `src/shared/orchestrator-failure.test.ts`: added focused tests for trigger matching and failure-message behavior.

## Turn Counter
- Turn 2

```ws-block:cli
{
  "id": "aaecdae7-423b-4d87-a393-e77ac1776890",
  "version": 1,
  "type": "cli",
  "createdAt": "2026-02-17T00:33:40.573Z",
  "createdBy": "agent",
  "command": "pnpm test -- orchestrator",
  "description": "Run orchestrator-focused tests",
  "cwd": "/Users/gannonhall/intent/workspaces/following-build-2/kata-cloud",
  "display": {
    "showCommandPrefix": "$"
  }
}
```

```ws-block:cli
{
  "id": "4964289a-3ee9-48f3-ac95-7dd6ff3ae307",
  "version": 1,
  "type": "cli",
  "createdAt": "2026-02-17T00:33:40.607Z",
  "createdBy": "agent",
  "command": "pnpm run desktop:typecheck",
  "description": "Typecheck desktop main+renderer",
  "cwd": "/Users/gannonhall/intent/workspaces/following-build-2/kata-cloud",
  "display": {
    "showCommandPrefix": "$"
  }
}
```