---
id: 22770f24-a79b-4d14-9add-14ffd1447b2f
title: Add in-app browser preview for local development
parent: spec
created: "2026-02-16T13:58:41.818Z"
task:
  status: waiting
  peerOrder: 900
  startedAt: "2026-02-17T03:47:32.869Z"
  assignedAgentIds: [agent-efb006f9-203a-47eb-8546-3e226b83cb69]
---

# Add in-app browser preview for local development

Embed browser panel to preview localhost and relevant docs without leaving app.

## Scope
Implement in-app browser tab for local preview URLs with basic navigation controls. Excludes cross-device emulation and advanced devtools.

## Inputs
`docs/kata-cloud-ovweview.md` section "In-app browser"
`[Spec](intent://local/note/spec)`

## Definition of Done
- User can open localhost URL inside app browser panel.
- Browser tab supports refresh/back/forward navigation.
- Browser panel coexists with core workspace views without breaking layout.

## Verification
- `pnpm run test -- browser`
- Manual: open `http://localhost:<port>` and validate navigation actions

## Conflict Resolution (2026-02-17)

Preflight conflict confirmed on shared files `src/shared/state.ts` and `src/shared/state.test.ts` due parallel context-adapter edits.

Coordinator decision:
1. No combined browser+context commit.
2. Browser task is paused (`waiting`) unless it can complete strictly in browser-only files.
3. Resume/finish browser shared-state integration after context task lands and branch is rebased from updated `main`.

## Implementation Evidence (2026-02-17)

Branch: `feature/in-app-browser-preview`
Commit: `f759c16ed771aee16c9bea3512edd1b77be0da16`
Push verification: `git ls-remote --heads origin feature/in-app-browser-preview` -> `f759c16ed771aee16c9bea3512edd1b77be0da16 refs/heads/feature/in-app-browser-preview`

Files changed:
- `src/main.tsx`
- `src/styles.css`
- `src/shared/state.ts`
- `src/shared/state.test.ts`
- `src/browser/local-dev-browser.ts`
- `src/browser/local-dev-browser.test.ts`

What changed:
- Added `Browser` view to navigation/state.
- Added in-app browser panel rendering localhost URLs inside an iframe.
- Added controls for `Back`, `Forward`, `Refresh`, and `Go`.
- Added URL normalization/localhost guard + browser history helper logic.
- Added browser helper tests and state-view validity test.

Verification run:
- `pnpm run test -- browser` ✅ pass
- `pnpm run desktop:typecheck` ✅ pass

Manual localhost preview/navigation evidence:
- Automated agent environment is headless for Electron UI interaction, so direct manual clickthrough evidence is pending verifier desktop run.
- Browser panel runtime path is wired in `src/main.tsx` with live iframe source updates plus back/forward/refresh/go actions and localhost URL validation.

## Scope Blocker Update (2026-02-17)

Coordinator constraint received: `src/shared/state.ts` and `src/shared/state.test.ts` are context-task-owned for this wave and must not be included in browser-only commit scope.

Evidence:
- Existing browser commit `f759c16ed771aee16c9bea3512edd1b77be0da16` includes:
  - `src/browser/local-dev-browser.test.ts`
  - `src/browser/local-dev-browser.ts`
  - `src/main.tsx`
  - `src/shared/state.test.ts`
  - `src/shared/state.ts`
  - `src/styles.css`
- Browser implementation currently depends on `NavigationView` supporting `"browser"` in `src/shared/state.ts` and corresponding state normalization test in `src/shared/state.test.ts`.

Blocking conclusion:
- Under current coordinator restriction, browser task cannot be completed as a clean isolated commit without touching those shared-state files.
- Task is paused awaiting context-task merge/landing and coordinator rebase/cherry-pick instruction.

## Rebase Prep (2026-02-17)

### Replay strategy
1. Start from a clean branch at `origin/main` (current tip observed: `64782e7`).
2. Replay browser work from commit `f759c16ed771aee16c9bea3512edd1b77be0da16` via cherry-pick (`-x`).
3. Use commit replay instead of branch replay because `origin/feature/in-app-browser-preview` is no longer present on remote (`git fetch origin feature/in-app-browser-preview` returns missing ref).
4. Expect one manual conflict in `src/main.tsx`; all other files from the browser commit apply cleanly.
5. Keep resolution browser-scoped: preserve all `origin/main` run-history/GitHub/changes flow while layering browser imports/state/callbacks/UI branch.

### Conflict map (dry-run on top of `origin/main`)
| File | Dry-run result | Resolution strategy |
| --- | --- | --- |
| `src/main.tsx` | `CONFLICT (content)` | Manual merge. Keep existing `origin/main` orchestrator run-history imports/state hooks and add browser imports/hooks/handlers + browser panel render branch. |
| `src/shared/state.ts` | Clean apply | Keep `NavigationView` extension with `"browser"` plus `isNavigationView` acceptance update. |
| `src/shared/state.test.ts` | Clean apply | Keep browser-active-view normalization test. |
| `src/styles.css` | Clean apply | Keep new `.browser-*` control/frame classes; no overlap with recent main updates. |
| `src/browser/local-dev-browser.ts` | Clean apply (new file) | Add as-is; pure helper module with localhost URL guard + history state transitions. |
| `src/browser/local-dev-browser.test.ts` | Clean apply (new file) | Add as-is; validates URL normalization/restriction and back/forward history stepping. |

Conflict detail from cherry-pick simulation:
- `src/main.tsx` conflict hunk 1: import block (browser helper import collides with newly-added run-history import from main).
- `src/main.tsx` conflict hunk 2: `App()` state hook section (browser hooks inserted where main now has extended changes/GitHub state hooks).

### Proposed file-level resolution plan
- `src/main.tsx`
  - Imports: keep both blocks (`./shared/orchestrator-run-history` and `./browser/local-dev-browser`).
  - `viewOrder`/labels: include `"browser"` in nav order and in `toViewLabel` switch.
  - `App()` hooks: keep all current `origin/main` git/changes/PR state hooks; append browser hooks (`browserNavigation`, `browserInput`, `browserRefreshKey`, `browserError`) after existing declarations.
  - Derived browser state: add `currentBrowserUrl`, `canGoBack`, `canGoForward` memos alongside other derived values.
  - Event handlers: add `onNavigateBrowser`, `onStepBrowserHistory`, `onRefreshBrowser` without altering existing orchestrator/spec/changes handlers.
  - Render path: extend focused panel condition/header subtitle logic for browser view; insert `state.activeView === "browser"` branch between changes branch and `SpecNotePanel` fallback.
- `src/shared/state.ts`
  - Keep `NavigationView` union extension (`| "browser"`) and guard acceptance in `isNavigationView`.
- `src/shared/state.test.ts`
  - Keep `it("keeps browser as a valid active view", ...)` test.
- `src/styles.css`
  - Keep browser UI styles (`.browser-controls`, `.browser-controls__url`, `.browser-controls__actions`, `.browser-frame-shell`, `.browser-frame-shell__url`, `.browser-frame`).
- `src/browser/local-dev-browser.ts`
  - Keep helper module unchanged.
- `src/browser/local-dev-browser.test.ts`
  - Keep tests unchanged.

### Execution checklist (implementor)
1. Sync and create replay branch:
   - `git fetch origin --prune`
   - `git switch -C codex/browser-preview-replay origin/main`
2. Replay browser commit:
   - `git cherry-pick -x f759c16ed771aee16c9bea3512edd1b77be0da16`
3. Resolve expected conflict in `src/main.tsx` using file-level plan above.
4. Stage all browser replay files:
   - `git add src/main.tsx src/shared/state.ts src/shared/state.test.ts src/styles.css src/browser/local-dev-browser.ts src/browser/local-dev-browser.test.ts`
5. Complete replay:
   - `git cherry-pick --continue`
6. Verify:
   - `pnpm run test -- browser`
   - `pnpm test -- state`
   - `pnpm run desktop:typecheck`
7. Manual UAT in desktop app:
   - Start app: `pnpm run dev`.
   - Open `Browser` tab from top nav.
   - Enter `localhost:5173` (or active local port), click `Go`, verify iframe loads and URL normalizes.
   - Enter `https://example.com`, click `Go`, verify validation error blocks non-localhost hosts.
   - Navigate to a second localhost URL, verify `Back`/`Forward` enablement and behavior.
   - Click `Refresh`, verify iframe reload (URL unchanged, frame remounts).
   - Switch to `Changes`/`Spec`/`Orchestrator` and back to `Browser`, verify UI remains stable and browser state remains coherent.

Notes:
- No PR opening in this prep step.
- No product-code commits were created for feasibility; only conflict dry-run (`cherry-pick --no-commit`) and planning analysis were performed.
