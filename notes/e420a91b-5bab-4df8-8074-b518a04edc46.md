---
id: e420a91b-5bab-4df8-8074-b518a04edc46
title: Enforce one-block-one-task for duplicate titles and normalize parser module boundary
parent: spec
created: "2026-02-16T15:08:31.900Z"
task:
  status: complete
  peerOrder: 200
  assignedAgentIds: [agent-31166be9-c133-4bd0-89f4-1906b4c58aaa]
  startedAt: "2026-02-16T15:15:41.168Z"
  completedAt: "2026-02-16T15:28:39.652Z"
---

# Enforce one-block-one-task for duplicate titles and normalize parser module boundary

Fix parser edge cases where duplicate task titles collapse into one record, and ensure parser module boundary works cleanly in current runtime/tooling.

## Scope
In scope: `packages/task-parser/src/task-sync.js`, `packages/task-parser/src/index.js`, parser tests, and minimal package metadata if needed.
Out of scope: non-parser feature behavior.

## Inputs
[Spec](intent://local/note/spec)
Task note: [Implement task block parsing and task-note conversion](intent://local/task/91331c4e-10c7-42cd-97be-7c63b6edfc35)
Verifier findings from `agent-5ee006d8-f4c1-4078-b2ae-19debd9f9ef8` and `agent-7cc2f25e-ce63-44d9-a9a1-da4f58d082d3`.

## Definition of Done
- Two `

## Summary (Turn 1)
Implemented parser-only remediation for duplicate-title cardinality and parser module boundary normalization. `syncTaskBlocks` now always provides an explicit ID for new block conversions, preventing title-collapsing stores from merging distinct `@@@task` blocks. Added a duplicate-title regression test and parser-local package metadata so Node treats parser sources as ESM under the repo’s CommonJS root.

## Acceptance Criteria
- ✅ Duplicate `@@@task` blocks with the same title produce distinct task records (one block -> one task).
- ✅ Parser package module boundary is normalized for runtime import (`packages/task-parser/package.json` with `"type": "module"`).
- ✅ Regression coverage added for duplicate-title collapse risk.
- ⚠️ Full Vitest suite execution remains blocked in this environment (missing `node_modules`/`vitest`).

## References
- `packages/task-parser/src/task-sync.js`
- `packages/task-parser/test/task-parser.test.js`
- `packages/task-parser/package.json`

## Learnings
- In mixed-module repos, a nested parser package needs its own module boundary declaration to keep ESM parser sources executable under Node.
- One-block-one-task behavior must not rely on title-only `upsert` behavior in downstream stores.

## Changes
- `packages/task-parser/src/task-sync.js`: set `upsert` input `id` to `existingTask?.id ?? randomUUID()` to force distinct IDs for new block conversions.
- `packages/task-parser/test/task-parser.test.js`: added regression test simulating a title-collapsing store and asserting duplicate-title blocks stay distinct.
- `packages/task-parser/package.json`: added parser-local metadata with `"type": "module"` and entry export.

## Verification Results
- `pnpm run test -- task-parser` -> **FAIL** (`vitest: command not found`; `node_modules` missing).
- `node --input-type=module -e "import('./packages/task-parser/src/index.js').then((m)=>console.log('exports',Object.keys(m).sort().join(',')))"` -> **PASS** (`exports checkboxForStatus,createInMemoryTaskStore,normalizeTaskTitle,parseTaskBlocks,parseTaskLinks,syncTaskBlocks`).
- `node --input-type=module <<'EOF' ... duplicate-title smoke ... EOF` -> **PASS** (`duplicate-title smoke: PASS`).

```ws-block:cli
{
  "id": "953375aa-489e-4f61-b007-7cb22783de8b",
  "version": 1,
  "type": "cli",
  "createdAt": "2026-02-16T15:21:16.462Z",
  "createdBy": "agent",
  "command": "pnpm run test -- task-parser",
  "description": "Scoped parser Vitest command (blocked until dependencies are installed)",
  "cwd": "/Users/gannonhall/intent/workspaces/following-build-2/kata-cloud",
  "display": {
    "showCommandPrefix": "$"
  }
}
```

```ws-block:cli
{
  "id": "848bc913-aa0a-4266-a1dd-13b8ba9b3f48",
  "version": 1,
  "type": "cli",
  "createdAt": "2026-02-16T15:21:16.501Z",
  "createdBy": "agent",
  "command": "node --input-type=module -e \"import('./packages/task-parser/src/index.js').then((m)=>console.log('exports',Object.keys(m).sort().join(',')))\"",
  "description": "Node runtime import smoke for parser module boundary",
  "cwd": "/Users/gannonhall/intent/workspaces/following-build-2/kata-cloud",
  "display": {
    "showCommandPrefix": "$"
  }
}
```

```ws-block:cli
{
  "id": "0c90b584-a28e-47c1-8a5d-609b511c0c4d",
  "version": 1,
  "type": "cli",
  "createdAt": "2026-02-16T15:21:16.547Z",
  "createdBy": "agent",
  "command": "node --input-type=module <<'EOF'\nimport assert from 'node:assert/strict';\nimport { syncTaskBlocks } from './packages/task-parser/src/index.js';\n\nconst tasksById = new Map();\nconst taskIdByTitle = new Map();\nlet sequence = 0;\nconst normalize = (title) => title.trim().toLowerCase().replace(/\\s+/g, ' ');\n\nconst store = {\n  findById(id) {\n    return id ? tasksById.get(id) ?? null : null;\n  },\n  findByTitle(title) {\n    const id = taskIdByTitle.get(normalize(title));\n    return id ? tasksById.get(id) ?? null : null;\n  },\n  upsert(input) {\n    const normalized = normalize(input.title);\n    const id = input.id ?? taskIdByTitle.get(normalized) ?? `task-${++sequence}`;\n    const next = { id, title: input.title, description: input.description ?? '', status: input.status ?? 'not_started' };\n    tasksById.set(id, next);\n    taskIdByTitle.set(normalized, id);\n    return next;\n  }\n};\n\nconst spec = [\n  '## Tasks',\n  '@@@task',\n  '# Duplicate title',\n  'First body.',\n  '@@@',\n  '',\n  '@@@task',\n  '# Duplicate title',\n  'Second body.',\n  '@@@'\n].join('\\n');\n\nconst result = syncTaskBlocks(spec, store);\nassert.equal(result.taskIds.length, 2);\nassert.equal(new Set(result.taskIds).size, 2);\nassert.equal((result.specMarkdown.match(/intent:\\/\\/local\\/task\\//g) || []).length, 2);\nconsole.log('duplicate-title smoke: PASS');\nEOF",
  "description": "Duplicate-title one-block-one-task smoke against a title-collapsing store",
  "cwd": "/Users/gannonhall/intent/workspaces/following-build-2/kata-cloud",
  "display": {
    "showCommandPrefix": "$"
  }
}
```