---
id: 91331c4e-10c7-42cd-97be-7c63b6edfc35
title: Implement task block parsing and task-note conversion
parent: spec
created: "2026-02-16T13:58:41.809Z"
task:
  status: complete
  peerOrder: 500
  assignedAgentIds: [agent-59f5302d-8ea2-4058-a368-5978b61b7989]
  startedAt: "2026-02-16T14:10:43.240Z"
  completedAt: "2026-02-16T14:21:12.888Z"
---

# Implement task block parsing and task-note conversion

Turn task blocks in the spec into executable task records and links.

## Scope
Parse `@@@task` blocks, create task-note entities, and keep spec links synchronized with task status. Primary implementation ownership is `packages/task-parser/**` (parser, conversion, idempotency logic, tests), with minimal integration touchpoints only. Excludes app shell/layout ownership and excludes agent assignment logic.

## Inputs
`docs/kata-cloud-ovweview.md` sections "Orchestrator of specialized agents" and "The spec"
`[Spec](intent://local/note/spec)`

## Definition of Done
- Each task block in the spec produces exactly one task-note record.
- Spec renders stable links to task notes and status transitions.
- Re-reading/updating spec does not duplicate previously converted tasks.

## Verification
- `pnpm run test -- task-parser`
- Manual: add/remove/update task blocks and validate task-note sync

## Summary (Turn 1)
Implement task-block conversion by wiring `@@@task` markdown blocks to a deterministic task-note upsert path, replacing block text with stable task links/status, and making conversion idempotent on repeated spec saves.

## Acceptance Criteria
- [x] Parsing detects every valid `@@@task` block in spec content.
- [x] Each parsed task block maps to exactly one persistent task note (no duplicates on re-save).
- [x] Rendered spec content contains stable task links (`intent://local/task/{id}`) and reflects task status transitions.
- [x] Updating/removing task blocks syncs links/state without creating duplicate tasks.
- [ ] Existing tests pass for parser/sync behavior via `pnpm run test -- task-parser` (blocked in this environment: `vitest` not installed and registry is unreachable).

## Subtasks
- [ ] None.

## References
- docs/kata-cloud-ovweview.md (sections: Orchestrator of specialized agents, The spec)
- intent://local/note/spec

## Learnings
- Concurrent scaffold updates landed mid-implementation; rebasing to `packages/task-parser/**` avoided overlap with bootstrap-owned shell/tooling files.
- Root package is ESM + Vitest-driven, so parser/test modules must be ESM-compatible to avoid runtime loader errors.

## Changes
- `packages/task-parser/src/task-block-parser.js`: Added `@@@task` block/link parsing and normalized title helpers.
- `packages/task-parser/src/task-sync.js`: Added task-note upsert/sync flow, link status rendering, deduplication, and idempotent in-memory task store.
- `packages/task-parser/src/index.js`: Exported parser + sync public API.
- `packages/task-parser/test/task-parser.test.js`: Added tests covering conversion cardinality, status-link sync, and idempotent re-read/update behavior.
- Removed prior root parser paths (`src/task-parser/**`, `test/task-parser.test.js`) to comply with coordinator path ownership (`packages/task-parser/**`).

## Coordinator Conflict Policy

Proceed immediately by rebasing/cherry-picking onto the latest bootstrap scaffold. Move parser/conversion implementation to `packages/task-parser/**` (do not keep parser internals under `src/**`). Keep integration into app shell minimal and additive. Treat `package.json`, `tsconfig*`, vitest/tooling, and app entry wiring as bootstrap-owned; only request targeted root-file edits if strictly required and document exact deltas.

## Summary (Turn 2)
Implemented parser/conversion logic under `packages/task-parser/**`, with idempotent task-note upsert behavior and stable `intent://local/task/{id}` link/status synchronization. Rebased onto concurrent scaffold updates and removed earlier root-path parser files to match coordinator ownership boundaries.

## Verification Results (Turn 2)
- `pnpm run test -- task-parser` -> **failed** (`vitest: command not found`; `node_modules` missing).
- `pnpm install` -> **failed** (offline environment; npm registry DNS resolution `ENOTFOUND registry.npmjs.org`).
- `node --input-type=module -e "..."` smoke check -> **passed** for conversion cardinality, stable link ID, status transition rendering, and idempotent re-read behavior.

## Summary (Turn 3)
Applied coordinator high-priority boundary policy against the latest scaffold state: parser internals remain exclusively under `packages/task-parser/**`, with no `src/**` parser ownership.

## Verification Results (Turn 3)
- `pnpm run test -- task-parser` -> **failed** (`vitest: command not found`; `node_modules` missing).

## Changes (Turn 3)
- No additional code changes required; verified ownership isolation and path compliance only.

## Summary (Turn 4)
Reviewed latest workspace event after bootstrap completion; no parser-scope ownership changes required. Parser internals remain only in `packages/task-parser/**` with no `src/**` parser files.

## Verification Results (Turn 4)
- Ownership check: `packages/task-parser/**` contains parser implementation/test files.
- Ownership check: no `src/task-parser/**` files present.
- `pnpm run test -- task-parser` remains blocked in this environment (`vitest` unavailable; missing dependencies).

## Summary (Turn 5)
Applied bootstrapâ€™s scaffold conventions confirmation: parser implementation remains in the agreed safe ownership zone `packages/task-parser/src/*` with tests in `packages/task-parser/test/*`; no shell-owned baseline files were modified for parser internals.

## Verification Results (Turn 5)
- `pnpm run test -- packages/task-parser` -> **failed** (`vitest: command not found`; `node_modules` missing).
- This matches prior verification blocker and does not indicate parser logic regression in this environment.